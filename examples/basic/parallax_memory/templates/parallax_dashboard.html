<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Memory | Cross-Call Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        .animate-slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        /* Enhanced card hover effects */
        .parallax-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .parallax-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.3);
        }

        /* Smooth button interactions */
        button {
            transition: all 0.2s ease;
        }

        button:active {
            transform: scale(0.98);
        }

        /* Better focus states */
        button:focus-visible,
        select:focus-visible {
            outline: 2px solid rgba(96, 165, 250, 0.6);
            outline-offset: 2px;
        }

        /* Improved empty state */
        .empty-state {
            animation: fadeIn 0.6s ease-out;
        }

        /* Enhanced progress indicator */
        .progress-glow {
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        /* Better badge hover effects */
        .keyword-badge {
            transition: all 0.2s ease;
        }

        .keyword-badge:hover {
            transform: translateY(-2px) scale(1.05);
        }
        :root {
            --mouse-x: 0.5;
            --mouse-y: 0.5;
            --scroll-y: 0;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
            50% { box-shadow: 0 0 30px rgba(96, 165, 250, 0.6); }
        }
        @keyframes slide-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .float { animation: float 3s ease-in-out infinite; }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .slide-in { animation: slide-in 0.5s ease-out; }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .gradient-text {
            background: linear-gradient(to right, #60a5fa, #c084fc, #f472b6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .tag-input:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        /* Sort Selector Styles */
        #sortSelector {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23cbd5e1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px;
            padding-right: 2.5rem;
        }

        #sortSelector:hover {
            background-color: rgba(30, 41, 59, 0.9);
            border-color: rgba(96, 165, 250, 0.5);
        }

        #sortSelector:focus {
            background-color: rgba(30, 41, 59, 0.95);
            border-color: rgba(96, 165, 250, 1);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        /* NEW Badge Animation */
        @keyframes pulse-glow-green {
            0%, 100% {
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
            }
        }

        .new-badge {
            animation: pulse-glow-green 2s ease-in-out infinite;
        }


        .lens-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .lens-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        /* Parallax Background Layer */
        body::before {
            content: '';
            position: fixed;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            background:
                radial-gradient(circle at 20% 30%, rgba(96, 165, 250, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(192, 132, 252, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(244, 114, 182, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
            transform:
                translateX(calc((var(--mouse-x) - 0.5) * 30px))
                translateY(calc((var(--mouse-y) - 0.5) * 30px))
                translateY(calc(var(--scroll-y) * 0.3px));
            transition: transform 0.15s ease-out;
        }

        /* Parallax Report Cards */
        .parallax-card {
            opacity: 0;
            transform: translateY(50px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .parallax-card.visible {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* Override opacity for animated cards - must be visible */
        .parallax-card.animate-fade-in {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* Subtle hover effect on cards */
        .parallax-card:hover {
            transform: translateY(-8px) !important;
            transition: transform 0.2s ease-out;
        }

        /* Grid overlay - subtle background structure */
        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -2;
            opacity: 0.05;
            background-image:
                linear-gradient(rgba(96, 165, 250, 0.04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(96, 165, 250, 0.04) 1px, transparent 1px);
            background-size: 60px 60px;
        }

        /* Enhanced glass effect */
        .glass-enhanced {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* Popover/Tooltip Styles */
        .popover-trigger {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
        }

        .popover-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            width: 280px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: translateX(-50%) translateY(-4px);
            z-index: 1000;
            font-size: 12px;
            line-height: 1.5;
            color: #cbd5e1;
        }

        .popover-trigger:hover .popover-content,
        .popover-trigger.active .popover-content {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(0);
        }

        .popover-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(15, 23, 42, 0.95);
        }

        .popover-content strong {
            color: #60a5fa;
            display: block;
            margin-bottom: 4px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-200 min-h-screen font-sans">

    <!-- Subtle Background Effects -->
    <div class="grid-overlay"></div>

    <nav class="glass-enhanced border-b border-slate-800 sticky top-0 z-50 backdrop-blur-md" id="mainNav">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-brain text-purple-500 text-2xl float"></i>
                <h1 class="text-2xl font-bold tracking-tight gradient-text">MASTER MEMORY</h1>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openSettings()"
                    class="bg-slate-800 hover:bg-slate-700 text-slate-200 px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 border border-slate-700 hover:border-slate-600 hover:shadow-lg hover:scale-105"
                    title="Configure watchlist keywords, scan limits, and lens settings">
                    <i class="fa-solid fa-sliders-h"></i> Configure
                </button>
                <button onclick="showMasterMemory()"
                    class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 shadow-lg hover:shadow-xl hover:scale-105"
                    title="View global master memory - aggregates insights from all calls across all customers">
                    <i class="fa-solid fa-brain"></i> Master Memory
                </button>
                <button onclick="refreshData()" id="refreshBtn"
                    class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 shadow-lg hover:shadow-xl hover:scale-105 pulse-glow"
                    title="Index and analyze call transcripts (up to 3 calls). Extracts per-call memories and updates master memory.">
                    <i class="fa-solid fa-radar"></i> Scan
                </button>
            </div>
        </div>
    </nav>

    <!-- Info Banner: How It Works -->
    <div id="infoBanner" class="max-w-7xl mx-auto px-6 py-3 border-b border-slate-800/50 bg-gradient-to-r from-slate-900/80 to-slate-800/80 backdrop-blur-sm">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-blue-500/20 to-purple-500/20 border border-blue-500/40 flex items-center justify-center">
                <i class="fa-solid fa-lightbulb text-blue-400 text-sm"></i>
            </div>
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <h3 class="text-sm font-bold text-blue-300">How Parallax Works</h3>
                    <button onclick="toggleInfoBanner()" class="text-slate-500 hover:text-slate-300 text-xs">
                        <i class="fa-solid fa-chevron-up" id="infoBannerToggle"></i>
                    </button>
                </div>
                <div id="infoBannerContent" class="text-xs text-slate-400 space-y-2">
                    <div class="flex items-start gap-2">
                        <i class="fa-solid fa-brain text-purple-400 mt-0.5"></i>
                        <div>
                            <span class="font-semibold text-purple-300">Global Cross-Call Intelligence:</span>
                            <span class="text-slate-400"> Master Memory aggregates insights from <strong>all calls across all customers</strong> using Mem0. Enables pattern detection, trend analysis, and cross-customer intelligence. <strong>No RAG/vector search</strong> - pure memory-based intelligence. Calls are automatically processed in parallel on page load.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col slide-in border border-slate-700 shadow-2xl">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-700">
                <h2 class="text-2xl font-bold gradient-text">Configuration</h2>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-white transition">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>

            <!-- Main Tabs -->
            <div class="flex gap-1 mb-4 border-b border-slate-700">
                <button onclick="switchMainTab('watchlist')" id="mainTabWatchlist"
                    class="px-4 py-2 text-sm font-semibold border-b-2 border-blue-500 text-blue-400 transition">
                    <i class="fa-solid fa-bullseye mr-2"></i>Watchlist
                </button>
                <button onclick="switchMainTab('lenses')" id="mainTabLenses"
                    class="px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-300 transition">
                    <i class="fa-solid fa-eye mr-2"></i>Lenses
                </button>
            </div>

            <!-- Watchlist Tab Content -->
            <div id="tabContentWatchlist" class="flex-1 overflow-y-auto">
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center gap-2 mb-4">
                            <p class="text-sm text-slate-400">Keywords to filter call transcripts</p>
                            <div class="popover-trigger">
                                <i class="fa-solid fa-circle-question text-slate-500 hover:text-blue-400 transition text-sm"></i>
                                <div class="popover-content">
                                    <strong>Watchlist Keywords</strong>
                                    Keywords mentioned in call transcripts. Calls matching these keywords will be analyzed. Examples: "product", "feature", "integration", "platform". Press Enter or click + to add.
                                </div>
                            </div>
                        </div>
                        <div id="watchlistTags" class="flex flex-wrap gap-2 min-h-[60px] p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                            <!-- Tags will be inserted here -->
                        </div>
                        <div class="flex gap-2 mt-2">
                            <input
                                type="text"
                                id="newWatchlistItem"
                                placeholder="Add keyword (e.g., product, feature, integration)"
                                class="tag-input flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500"
                                onkeypress="if(event.key === 'Enter') addWatchlistItem()"
                            >
                            <button onclick="addWatchlistItem()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg transition">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-slate-700">
                        <div class="flex items-center gap-2 mb-2">
                            <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Scan Limit</label>
                            <div class="popover-trigger">
                                <i class="fa-solid fa-circle-question text-slate-500 hover:text-blue-400 transition text-xs"></i>
                                <div class="popover-content">
                                    <strong>Scan Limit</strong>
                                    Controls how many call transcripts to analyze. Higher values = more coverage but slower scans. Recommended: 20-50 for balance.
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-slate-300 mb-2">Number of call transcripts to analyze (1-100)</p>
                        <div class="flex items-center gap-3">
                            <input
                                type="number"
                                id="scanLimit"
                                min="1"
                                max="100"
                                value="3"
                                class="w-24 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:border-blue-500"
                            >
                            <span class="text-xs text-slate-400">calls</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lenses Tab Content -->
            <div id="tabContentLenses" class="flex-1 overflow-y-auto hidden">
                <!-- Lens Sub-Tabs -->
                <div class="flex gap-1 mb-4 border-b border-slate-700">
                    <div class="relative group">
                        <button onclick="switchLensTab('SALES')" id="tabSALES"
                        class="px-4 py-2 text-sm font-semibold border-b-2 border-amber-500 text-amber-400 transition">
                            SALES
                    </button>
                        <div class="absolute bottom-full left-0 mb-2 w-72 p-3 bg-slate-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-amber-500/40">
                            <div class="font-semibold text-amber-300 mb-1">Sales Perspective</div>
                            <div class="text-slate-300">Analyzes deal value, decision stage, objections, and closing signals. Powered by LLM with structured JSON output.</div>
                            <div class="absolute bottom-0 left-4 translate-y-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"></div>
                        </div>
                    </div>
                    <div class="relative group">
                        <button onclick="switchLensTab('MARKETING')" id="tabMARKETING"
                        class="px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-300 transition">
                            MARKETING
                    </button>
                        <div class="absolute bottom-full left-0 mb-2 w-72 p-3 bg-slate-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-cyan-500/40">
                            <div class="font-semibold text-cyan-300 mb-1">Marketing Perspective</div>
                            <div class="text-slate-300">Extracts customer sentiment, messaging effectiveness, brand perception, and competitive mentions. Uses dynamic schemas.</div>
                            <div class="absolute bottom-0 left-4 translate-y-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"></div>
                        </div>
                    </div>
                    <div class="relative group">
                        <button onclick="switchLensTab('PRODUCT')" id="tabPRODUCT"
                            class="px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-300 transition">
                            PRODUCT
                        </button>
                        <div class="absolute bottom-full left-0 mb-2 w-72 p-3 bg-slate-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-green-500/40">
                            <div class="font-semibold text-green-300 mb-1">Product Perspective</div>
                            <div class="text-slate-300">Identifies feature requests, pain points, use cases, and product-market fit signals. Runs concurrently with other lenses.</div>
                            <div class="absolute bottom-0 left-4 translate-y-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"></div>
                        </div>
                    </div>
                </div>

                <!-- SALES Lens Config -->
                <div id="lensConfigSALES" class="lens-config-panel">
                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Prompt Template</label>
                                <div class="popover-trigger">
                                    <i class="fa-solid fa-circle-question text-slate-500 hover:text-amber-400 transition text-xs"></i>
                                    <div class="popover-content">
                                        <strong>Prompt Template</strong>
                                        Customize the AI's analysis prompt. Use placeholders: {role} = lens name, {watchlist} = keywords, {format_instructions} = JSON schema. Advanced users only.
                                    </div>
                                </div>
                            </div>
                            <textarea
                                id="salesPrompt"
                                rows="5"
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-200 font-mono focus:outline-none focus:border-amber-500"
                                placeholder="You are the {role} Specialist. Analyze this call transcript for sales opportunities, objections, closing signals, and deal value...\n\n{format_instructions}"
                            ></textarea>
                            <p class="text-xs text-slate-300 mt-1">Use {role}, {watchlist}, {format_instructions}</p>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Schema Fields</label>
                                    <div class="popover-trigger">
                                        <i class="fa-solid fa-circle-question text-slate-500 hover:text-amber-400 transition text-xs"></i>
                                        <div class="popover-content">
                                            <strong>Schema Fields</strong>
                                            Define the data structure for this lens. Each field has: name, type (str/int/bool/Literal), description. Literal types allow specific values (e.g., Low/Medium/High). Fields marked as "badge" display as status badges in the UI.
                                        </div>
                                    </div>
                                </div>
                                <button onclick="addSchemaField('SALES')" class="text-xs bg-amber-600 hover:bg-amber-500 px-2 py-1 rounded transition">
                                    <i class="fa-solid fa-plus mr-1"></i>Add
                                </button>
                            </div>
                            <div id="salesSchemaFields" class="space-y-2 max-h-64 overflow-y-auto">
                                <!-- Schema fields will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MARKETING Lens Config -->
                <div id="lensConfigMARKETING" class="lens-config-panel hidden">
                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Prompt Template</label>
                                <div class="popover-trigger">
                                    <i class="fa-solid fa-circle-question text-slate-500 hover:text-cyan-400 transition text-xs"></i>
                                    <div class="popover-content">
                                        <strong>Prompt Template</strong>
                                        Customize the AI's analysis prompt. Use placeholders: {role} = lens name, {format_instructions} = JSON schema. Advanced users only.
                                    </div>
                                </div>
                            </div>
                            <textarea
                                id="marketingPrompt"
                                rows="5"
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-200 font-mono focus:outline-none focus:border-cyan-500"
                                placeholder="You are the {role} Specialist. Analyze this call transcript for messaging, positioning, campaign insights, and customer sentiment...\n\n{format_instructions}"
                            ></textarea>
                            <p class="text-xs text-slate-300 mt-1">Use {role}, {format_instructions}</p>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Schema Fields</label>
                                    <div class="popover-trigger">
                                        <i class="fa-solid fa-circle-question text-slate-500 hover:text-cyan-400 transition text-xs"></i>
                                        <div class="popover-content">
                                            <strong>Schema Fields</strong>
                                            Define the data structure for this lens. Each field has: name, type (str/int/bool/Literal), description. Literal types allow specific values (e.g., Low/Medium/High). Fields marked as "badge" display as status badges in the UI.
                                        </div>
                                    </div>
                                </div>
                                <button onclick="addSchemaField('MARKETING')" class="text-xs bg-cyan-600 hover:bg-cyan-500 px-2 py-1 rounded transition">
                                    <i class="fa-solid fa-plus mr-1"></i>Add
                                </button>
                            </div>
                            <div id="marketingSchemaFields" class="space-y-2 max-h-64 overflow-y-auto">
                                <!-- Schema fields will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRODUCT Lens Config -->
                <div id="lensConfigPRODUCT" class="lens-config-panel hidden">
                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Prompt Template</label>
                                <div class="popover-trigger">
                                    <i class="fa-solid fa-circle-question text-slate-500 hover:text-green-400 transition text-xs"></i>
                                    <div class="popover-content">
                                        <strong>Prompt Template</strong>
                                        Customize the AI's analysis prompt. Use placeholders: {role} = lens name, {format_instructions} = JSON schema. Advanced users only.
                                    </div>
                                </div>
                            </div>
                            <textarea
                                id="productPrompt"
                                rows="5"
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-200 font-mono focus:outline-none focus:border-green-500"
                                placeholder="You are the {role} Specialist. Analyze this call transcript for feature requests, pain points, product-market fit, and use cases...\n\n{format_instructions}"
                            ></textarea>
                            <p class="text-xs text-slate-300 mt-1">Use {role}, {format_instructions}</p>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Schema Fields</label>
                                    <div class="popover-trigger">
                                        <i class="fa-solid fa-circle-question text-slate-500 hover:text-green-400 transition text-xs"></i>
                                        <div class="popover-content">
                                            <strong>Schema Fields</strong>
                                            Define the data structure for this lens. Each field has: name, type (str/int/bool/Literal), description. Literal types allow specific values (e.g., Low/Medium/High). Fields marked as "badge" display as status badges in the UI.
                                        </div>
                                    </div>
                                </div>
                                <button onclick="addSchemaField('PRODUCT')" class="text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded transition">
                                    <i class="fa-solid fa-plus mr-1"></i>Add
                                </button>
                            </div>
                            <div id="productSchemaFields" class="space-y-2 max-h-64 overflow-y-auto">
                                <!-- Schema fields will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer Actions -->
            <div class="flex gap-3 justify-end pt-4 mt-4 border-t border-slate-700">
                <button onclick="closeSettings()" class="px-4 py-2 rounded-lg border border-slate-700 hover:bg-slate-800 transition text-sm">
                    Cancel
                </button>
                <button onclick="saveSettings()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-semibold transition text-sm">
                    <i class="fa-solid fa-save mr-2"></i>Save
                </button>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-6 py-10 space-y-8">

        <!-- Master Memory Hero Section -->
        <div id="masterMemoryHero" class="relative overflow-hidden glass-enhanced border border-purple-500/30 rounded-2xl p-8 bg-gradient-to-br from-purple-900/30 via-indigo-900/20 to-slate-900/40 shadow-2xl">
            <!-- Background Pattern -->
            <div class="absolute inset-0 opacity-5">
                <div class="absolute inset-0" style="background-image: radial-gradient(circle at 2px 2px, rgba(192, 132, 252, 0.3) 1px, transparent 0); background-size: 40px 40px;"></div>
            </div>
            
            <div class="relative z-10">
                <div class="flex items-start justify-between gap-6 mb-6">
                    <div class="flex-1">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500/40 to-indigo-500/40 border-2 border-purple-500/60 flex items-center justify-center shadow-lg shadow-purple-500/20">
                                <i class="fa-solid fa-brain text-purple-200 text-3xl"></i>
                            </div>
                            <div>
                                <h2 class="text-4xl font-bold text-white mb-1 tracking-tight">Master Memory</h2>
                                <p class="text-sm text-purple-300/80 font-medium">Global cross-call intelligence powered by Mem0</p>
                            </div>
                        </div>
                        <p class="text-slate-200 leading-relaxed mb-6 text-lg max-w-3xl">
                            Master Memory aggregates insights from <strong class="text-purple-300">all calls across all customers</strong> using Mem0. 
                            Enables pattern detection, trend analysis, and cross-customer intelligence. 
                            <strong class="text-purple-300">No RAG/vector search</strong> - pure memory-based intelligence.
                        </p>
                        <div class="flex items-center gap-3 flex-wrap">
                            <button onclick="showMasterMemoryChat()" 
                                class="px-6 py-3.5 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white rounded-xl font-semibold transition-all flex items-center gap-2 shadow-lg hover:shadow-xl hover:scale-105 border border-purple-400/30">
                                <i class="fa-solid fa-comments text-lg"></i> Chat with Master Memory
                            </button>
                            <button onclick="showMasterMemory()" 
                                class="px-6 py-3.5 bg-slate-800/80 hover:bg-slate-700/80 text-slate-200 rounded-xl font-semibold transition-all flex items-center gap-2 border border-slate-600/50 hover:border-slate-500/50 backdrop-blur-sm">
                                <i class="fa-solid fa-list"></i> View All Insights
                            </button>
                            <button onclick="loadMasterMemoryPatterns()" 
                                class="px-6 py-3.5 bg-slate-800/80 hover:bg-slate-700/80 text-slate-200 rounded-xl font-semibold transition-all flex items-center gap-2 border border-slate-600/50 hover:border-slate-500/50 backdrop-blur-sm">
                                <i class="fa-solid fa-chart-line"></i> Patterns
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Master Memory Stats -->
                <div id="masterMemoryStats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
                    <div class="bg-gradient-to-br from-purple-900/40 to-purple-800/20 border border-purple-500/40 rounded-xl p-5 backdrop-blur-sm hover:border-purple-400/60 transition-all group">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs text-purple-300/70 font-semibold uppercase tracking-wider">Total Insights</div>
                            <i class="fa-solid fa-lightbulb text-purple-400/50 group-hover:text-purple-400 transition-colors"></i>
                        </div>
                        <div class="text-3xl font-bold text-purple-200" id="totalInsights">-</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-900/40 to-blue-800/20 border border-blue-500/40 rounded-xl p-5 backdrop-blur-sm hover:border-blue-400/60 transition-all group">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs text-blue-300/70 font-semibold uppercase tracking-wider">Calls Analyzed</div>
                            <i class="fa-solid fa-phone text-blue-400/50 group-hover:text-blue-400 transition-colors"></i>
                        </div>
                        <div class="text-3xl font-bold text-blue-200" id="callsAnalyzed">-</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-900/40 to-green-800/20 border border-green-500/40 rounded-xl p-5 backdrop-blur-sm hover:border-green-400/60 transition-all group">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs text-green-300/70 font-semibold uppercase tracking-wider">Customers</div>
                            <i class="fa-solid fa-building text-green-400/50 group-hover:text-green-400 transition-colors"></i>
                        </div>
                        <div class="text-3xl font-bold text-green-200" id="customersCount">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Master Memory Insights Feed with Tabs -->
        <div id="masterMemoryInsights" class="mt-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-white flex items-center gap-3 mb-1">
                        <i class="fa-solid fa-lightbulb text-purple-400"></i>
                        Master Memory Insights
                    </h3>
                    <p class="text-sm text-slate-400 ml-11">Browse insights by call or view all with filtering</p>
                </div>
                <button onclick="loadMasterMemoryInsights()" class="px-4 py-2 bg-slate-800/50 hover:bg-slate-700/50 text-slate-300 rounded-lg transition-all flex items-center gap-2 border border-slate-700/50 hover:border-slate-600/50">
                    <i class="fa-solid fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <!-- Memory Tabs -->
            <div class="mb-6">
                <div class="flex items-center gap-2 overflow-x-auto pb-2 border-b border-slate-800/50" id="memoryTabsContainer">
                    <!-- Tabs will be dynamically generated -->
                </div>
            </div>
            
            <!-- Filters (shown only for ALL tab) -->
            <div id="memoryFilters" class="mb-6 flex items-center gap-4 flex-wrap">
                <div class="flex items-center gap-2">
                    <label class="text-sm text-slate-400">Filter by Customer:</label>
                    <select id="customerFilter" onchange="filterMemories()" 
                        class="px-3 py-1.5 bg-slate-800/70 border border-slate-700 rounded-lg text-sm text-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="">All Customers</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm text-slate-400">Filter by Call:</label>
                    <select id="callFilter" onchange="filterMemories()" 
                        class="px-3 py-1.5 bg-slate-800/70 border border-slate-700 rounded-lg text-sm text-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="">All Calls</option>
                    </select>
                </div>
            </div>
            
            <!-- Insights Container -->
            <div id="insightsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- Loading state will be replaced -->
            </div>
        </div>

        <!-- Reports Container - Focusing on Calls with Memories (no snippets/RAG) -->
        {% if False %}
        {% for r in reports %}
        <div class="group relative glass-enhanced border border-slate-800 rounded-2xl overflow-hidden transition-all duration-300 shadow-2xl parallax-card hover:shadow-2xl">

            <!-- Enhanced Card Header -->
            <div class="relative bg-gradient-to-br from-slate-800/60 via-slate-800/50 to-slate-900/50 p-4 border-b border-slate-700/80 backdrop-blur-sm">
                <!-- Header Top Row: Source Detected + Matched Keywords -->
                <div class="flex items-center justify-between gap-3 mb-3 flex-wrap">
                    <!-- Left: Source Detected + Matched Keywords -->
                    <div class="flex items-center gap-3 flex-wrap flex-1">
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-semibold bg-blue-500/15 text-blue-300 border border-blue-500/40 uppercase tracking-wider backdrop-blur-sm">
                            <i class="fa-solid fa-radar text-[10px]"></i>Source Detected
                        </span>
                        {% if r.matched_keywords %}
                        <div class="flex items-center gap-2 flex-wrap">
                            {% for kw in r.matched_keywords %}
                            <span class="keyword-badge inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[11px] font-semibold bg-gradient-to-r from-green-600/20 to-emerald-600/20 text-green-300 border border-green-500/40 uppercase tracking-wide shadow-sm hover:shadow-md hover:border-green-500/60 cursor-pointer">
                                <i class="fa-solid fa-tag text-[9px]"></i>{{ kw }}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Right: View Memories Button + NEW Badge + Timestamp -->
                    <div class="flex items-center gap-3">
                        {% set company = (r.customer_company if r.customer_company else (r.repo_name.split(' - ')[0] if ' - ' in r.repo_name else 'unknown')) %}
                        {% if can_show_memories %}
                        <div class="relative group">
                            <button onclick="showCustomerMemories('{{ company }}', '{{ r.call_id or r.repo_id }}')" 
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-semibold bg-gradient-to-r from-blue-600/20 to-indigo-600/20 text-blue-300 border border-blue-500/40 hover:from-blue-600/30 hover:to-indigo-600/30 hover:border-blue-500/60 transition-all duration-200 cursor-pointer"
                                title="View per-call memories - insights extracted from this specific call using Mem0 (memory-only, no RAG)">
                                <i class="fa-solid fa-brain text-[10px]"></i>View Memories
                            </button>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-2 bg-slate-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-blue-500/40">
                                <div class="flex items-start gap-2">
                                    <i class="fa-solid fa-brain text-blue-400 mt-0.5"></i>
                                    <div>
                                        <div class="font-semibold text-blue-300 mb-1">Per-Call Memories (Mem0)</div>
                                        <div class="text-slate-300">Memories extracted from this specific call using Mem0. Each call has its own memory store. Memory-only approach - no RAG/vector search.</div>
                                    </div>
                                </div>
                                <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"></div>
                            </div>
                        </div>
                        <div class="relative group">
                            <button onclick="showLongitudinalIntelligence('{{ company }}')" 
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-semibold bg-gradient-to-r from-purple-600/20 to-pink-600/20 text-purple-300 border border-purple-500/40 hover:from-purple-600/30 hover:to-pink-600/30 hover:border-purple-500/60 transition-all duration-200 cursor-pointer">
                                <i class="fa-solid fa-sparkles text-[10px]"></i>Longitudinal AI
                            </button>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-72 p-2 bg-slate-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-purple-500/40">
                                <div class="flex items-start gap-2">
                                    <i class="fa-solid fa-sparkles text-purple-400 mt-0.5"></i>
                                    <div>
                                        <div class="font-semibold text-purple-300 mb-1">Longitudinal AI Intelligence</div>
                                        <div class="text-slate-300">Pattern recognition, sentiment velocity, contradictions, and relationship health across all calls. The "magical layer" that powers strategic insights.</div>
                                    </div>
                                </div>
                                <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"></div>
                            </div>
                        </div>
                        {% endif %}
                        {% if r.is_fresh %}
                        <span class="new-badge inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-bold bg-gradient-to-r from-green-600/90 to-emerald-600/90 text-white border border-green-500/60 uppercase tracking-wider shadow-lg shadow-green-500/30 backdrop-blur-sm">
                            <i class="fa-solid fa-sparkles text-[10px]"></i>NEW
                        </span>
                        {% endif %}
                        <div class="flex items-center gap-2 text-xs text-slate-300">
                            <i class="fa-solid fa-clock text-[10px]"></i>
                            <time datetime="{{ r.timestamp if r.timestamp else '' }}" class="font-mono">
                                {{ r.timestamp[:10] if r.timestamp else 'Unknown' }}
                            </time>
                        </div>
                    </div>
                </div>

                <!-- Title Section -->
                <div class="mb-3">
                <div class="group block">
                    <h2 class="text-lg font-bold text-white leading-snug pr-6">
                        {{ r.original_title if r.original_title else r.repo_name }}
                        </h2>
                                <div class="flex items-center gap-3 mt-2 text-xs text-slate-400 flex-wrap">
                        {% if r.repo_name and ' - ' in r.repo_name %}
                        {% set parts = r.repo_name.split(' - ') %}
                                    <span class="flex items-center gap-1">
                            <i class="fa-solid fa-building text-cyan-400"></i>
                            {{ parts[0] }}
                                    </span>
                                    <span class="flex items-center gap-1">
                            <i class="fa-solid fa-phone text-blue-400"></i>
                            {{ parts[1] if parts|length > 1 else 'Call' }}
                                    </span>
                                    {% endif %}
                        {% if r.repo_owner %}
                                    <span class="flex items-center gap-1">
                            <i class="fa-solid fa-user text-green-400"></i>
                            {{ r.repo_owner }}
                                    </span>
                                    {% endif %}
                        {% if r.timestamp %}
                                    <span class="flex items-center gap-1">
                            <i class="fa-solid fa-clock text-yellow-400"></i>
                            {{ r.timestamp[:10] if r.timestamp else 'Unknown' }}
                                    </span>
                                    {% endif %}
                    </div>
                </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-slate-800">

                <!-- SALES Lens -->
                <div class="p-4 hover:bg-slate-800/30 transition lens-card relative group">
                    <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700/50">
                        <div class="flex items-center gap-1.5 text-amber-400">
                            <i class="fa-solid fa-dollar-sign text-xs"></i>
                            <h3 class="text-xs font-bold uppercase tracking-wider">SALES</h3>
                            <div class="relative">
                                <i class="fa-solid fa-circle-question text-[8px] text-amber-500/60 hover:text-amber-400 cursor-help ml-1"></i>
                                <div class="absolute bottom-full left-0 mb-2 w-56 p-2 bg-slate-800 text-white text-[10px] rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-amber-500/40">
                                    <div class="font-semibold text-amber-300 mb-1">Sales Analysis</div>
                                    <div class="text-slate-300">LLM analyzes deal value, decision stage, objections, and closing signals. Uses structured JSON output for consistency.</div>
                                    <div class="absolute bottom-0 left-2 translate-y-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"></div>
                                </div>
                            </div>
                        </div>
                        {% if r.sales and r.sales.get('closing_probability') %}
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded
                            {% if r.sales.get('closing_probability') == 'High' %} bg-green-500/20 text-green-400 border border-green-800/50
                            {% elif r.sales.get('closing_probability') == 'Medium' %} bg-yellow-500/20 text-yellow-400 border border-yellow-800/50
                            {% else %} bg-slate-500/20 text-slate-400 border border-slate-700/50 {% endif %}">
                            {{ r.sales.get('closing_probability', 'N/A') }}
                                    </span>
                                    {% endif %}
                    </div>
                    <div class="space-y-3">
                        {% if r.sales %}
                        {% if r.sales.get('deal_value') %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Deal Value</p>
                            <p class="text-xs text-slate-300 leading-relaxed">{{ r.sales.get('deal_value', 'N/A') }}</p>
                        </div>
                        {% endif %}
                        {% if r.sales.get('decision_stage') %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Decision Stage</p>
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-500/20 text-blue-400 border border-blue-800/50">
                                {{ r.sales.get('decision_stage', 'N/A') }}
                                    </span>
                                </div>
                        {% endif %}
                        {% if r.sales.get('products_discussed') %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Products Discussed</p>
                            <div class="flex flex-wrap gap-1.5 mt-1">
                                {% for product in r.sales.get('products_discussed', []) %}
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-semibold bg-green-600/20 text-green-300 border border-green-500/40">
                                    {{ product }}
                                </span>
                                {% endfor %}
                            </div>
                                    </div>
                                    {% endif %}
                        {% if r.sales.get('pain_points') %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Pain Points</p>
                            <ul class="text-xs text-slate-300 space-y-1">
                                {% for point in r.sales.get('pain_points', []) %}
                                <li class="flex items-start gap-1">
                                    <i class="fa-solid fa-circle text-[6px] mt-1.5 text-amber-400"></i>
                                    <span>{{ point }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                                    </div>
                                    {% endif %}
                        {% if r.sales.get('key_insight') %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Key Insight</p>
                            <p class="text-xs text-slate-300 leading-relaxed">{{ r.sales.get('key_insight', 'N/A') }}</p>
                                </div>
                                {% endif %}
                        {% else %}
                        <p class="text-xs text-slate-400 italic">No sales analysis available</p>
                        {% endif %}
                </div>
            </div>

                <!-- MARKETING Lens -->
                <div class="p-4 hover:bg-slate-800/30 transition lens-card relative group">
                    <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700/50">
                        <div class="flex items-center gap-1.5 text-cyan-400">
                            <i class="fa-solid fa-bullhorn text-xs"></i>
                            <h3 class="text-xs font-bold uppercase tracking-wider">MARKETING</h3>
                            <div class="relative">
                                <i class="fa-solid fa-circle-question text-[8px] text-cyan-500/60 hover:text-cyan-400 cursor-help ml-1"></i>
                                <div class="absolute bottom-full left-0 mb-2 w-56 p-2 bg-slate-800 text-white text-[10px] rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-cyan-500/40">
                                    <div class="font-semibold text-cyan-300 mb-1">Marketing Analysis</div>
                                    <div class="text-slate-300">Extracts customer sentiment, messaging effectiveness, and brand perception. Uses dynamic Pydantic schemas configured in MongoDB.</div>
                                    <div class="absolute bottom-0 left-2 translate-y-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"></div>
                        </div>
                    </div>
                        </div>
                        {% if r.marketing and r.marketing.get('customer_sentiment') %}
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded
                            {% if 'Very Positive' in r.marketing.get('customer_sentiment') or r.marketing.get('customer_sentiment') == 'Positive' %} bg-green-500/20 text-green-400 border border-green-800/50
                            {% elif 'Very Negative' in r.marketing.get('customer_sentiment') or r.marketing.get('customer_sentiment') == 'Negative' %} bg-red-500/20 text-red-400 border border-red-800/50
                            {% else %} bg-slate-500/20 text-slate-400 border border-slate-700/50 {% endif %}">
                            {{ r.marketing.get('customer_sentiment', 'N/A') }}
                        </span>
                        {% endif %}
                        {% if r.marketing and r.marketing.get('engagement_level') %}
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded ml-2
                            {% if 'Very High' in r.marketing.get('engagement_level') or r.marketing.get('engagement_level') == 'High' %} bg-blue-500/20 text-blue-400 border border-blue-800/50
                            {% elif 'Very Low' in r.marketing.get('engagement_level') or r.marketing.get('engagement_level') == 'Low' %} bg-slate-500/20 text-slate-400 border border-slate-700/50
                            {% else %} bg-slate-500/20 text-slate-400 border border-slate-700/50 {% endif %}">
                            {{ r.marketing.get('engagement_level', 'N/A') }}
                        </span>
                        {% endif %}
                    </div>
                    <div class="space-y-3">
                        {% if r.marketing %}
                        {% if r.marketing.get('messaging_resonance') and r.marketing.get('messaging_resonance') != 'Not clearly evident' %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Messaging Resonance</p>
                            <p class="text-xs text-slate-300 leading-relaxed">{{ r.marketing.get('messaging_resonance', 'N/A') }}</p>
                            </div>
                            {% endif %}
                        {% if r.marketing.get('brand_perception') and r.marketing.get('brand_perception') != 'Not discussed' %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Brand Perception</p>
                            <p class="text-xs text-slate-300 leading-relaxed">{{ r.marketing.get('brand_perception', 'N/A') }}</p>
                        </div>
                        {% endif %}
                        {% if r.marketing.get('customer_language') and r.marketing.get('customer_language') != 'Not evident' %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Customer Language</p>
                            <p class="text-xs text-slate-300 leading-relaxed italic">{{ r.marketing.get('customer_language', 'N/A') }}</p>
                        </div>
                        {% endif %}
                        {% if r.marketing.get('competitive_mentions') and r.marketing.get('competitive_mentions')|length > 0 %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Competitors Mentioned</p>
                            <div class="flex flex-wrap gap-1.5 mt-1">
                                {% for competitor in r.marketing.get('competitive_mentions', []) %}
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-semibold bg-red-600/20 text-red-300 border border-red-500/40">
                                    {{ competitor }}
                                </span>
                                {% endfor %}
                        </div>
                        </div>
                        {% endif %}
                        {% if r.marketing.get('pain_points_mentioned') and r.marketing.get('pain_points_mentioned')|length > 0 %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Pain Points Mentioned</p>
                            <ul class="text-xs text-slate-300 space-y-1">
                                {% for pain in r.marketing.get('pain_points_mentioned', []) %}
                                <li class="flex items-start gap-1">
                                    <i class="fa-solid fa-exclamation-triangle text-[6px] mt-1.5 text-orange-400"></i>
                                    <span>{{ pain }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% if r.marketing.get('key_insight') %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Key Insight</p>
                            <p class="text-xs text-slate-300 leading-relaxed">{{ r.marketing.get('key_insight', 'N/A') }}</p>
                        </div>
                        {% endif %}
                        {% else %}
                        <p class="text-xs text-slate-400 italic">No marketing analysis available</p>
                        {% endif %}
                    </div>
                </div>

                <!-- PRODUCT Lens -->
                <div class="p-4 hover:bg-slate-800/30 transition lens-card relative group">
                    <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700/50">
                        <div class="flex items-center gap-1.5 text-green-400">
                            <i class="fa-solid fa-box text-xs"></i>
                            <h3 class="text-xs font-bold uppercase tracking-wider">PRODUCT</h3>
                            <div class="relative">
                                <i class="fa-solid fa-circle-question text-[8px] text-green-500/60 hover:text-green-400 cursor-help ml-1"></i>
                                <div class="absolute bottom-full left-0 mb-2 w-56 p-2 bg-slate-800 text-white text-[10px] rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-green-500/40">
                                    <div class="font-semibold text-green-300 mb-1">Product Analysis</div>
                                    <div class="text-slate-300">Identifies feature requests, pain points, and product-market fit. Runs concurrently with SALES and MARKETING lenses for parallel processing.</div>
                                    <div class="absolute bottom-0 left-2 translate-y-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"></div>
                        </div>
                    </div>
                        </div>
                        {% if r.product and r.product.get('product_fit_score') %}
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded
                            {% if r.product.get('product_fit_score') == 'Excellent' %} bg-green-500/20 text-green-400 border border-green-800/50
                            {% elif r.product.get('product_fit_score') == 'Good' %} bg-blue-500/20 text-blue-400 border border-blue-800/50
                            {% elif r.product.get('product_fit_score') == 'Fair' %} bg-yellow-500/20 text-yellow-400 border border-yellow-800/50
                            {% else %} bg-red-500/20 text-red-400 border border-red-800/50 {% endif %}">
                            {{ r.product.get('product_fit_score', 'N/A') }}
                            </span>
                        {% endif %}
                    </div>
                    <div class="space-y-3">
                        {% if r.product %}
                        {% if r.product.get('feature_requests') %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Feature Requests</p>
                            <ul class="text-xs text-slate-300 space-y-1">
                                {% for feature in r.product.get('feature_requests', []) %}
                                <li class="flex items-start gap-1">
                                    <i class="fa-solid fa-lightbulb text-[6px] mt-1.5 text-green-400"></i>
                                    <span>{{ feature }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% if r.product.get('pain_points') %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Pain Points</p>
                            <ul class="text-xs text-slate-300 space-y-1">
                                {% for point in r.product.get('pain_points', []) %}
                                <li class="flex items-start gap-1">
                                    <i class="fa-solid fa-exclamation-triangle text-[6px] mt-1.5 text-orange-400"></i>
                                    <span>{{ point }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% if r.product.get('use_cases') %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Use Cases</p>
                            <ul class="text-xs text-slate-300 space-y-1">
                                {% for use_case in r.product.get('use_cases', []) %}
                                <li class="flex items-start gap-1">
                                    <i class="fa-solid fa-check-circle text-[6px] mt-1.5 text-green-400"></i>
                                    <span>{{ use_case }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% if r.product.get('key_insight') %}
                        <div>
                            <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Key Insight</p>
                            <p class="text-xs text-slate-300 leading-relaxed">{{ r.product.get('key_insight', 'N/A') }}</p>
                        </div>
                        {% endif %}
                        {% else %}
                        <p class="text-xs text-slate-400 italic">No product analysis available</p>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
        {% endfor %}
            </div>
        </div>
        {% endif %}
    </main>

    <script>
        // Helper to read cookies for CSRF token
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }

        // Cache DOM elements
        const elements = {
            settingsModal: null,
            watchlistTags: null,
            scanLimit: null,
            maxLimit: null,
            newWatchlistItem: null,
            watchlistDisplay: null
        };

        // Initialize DOM cache
        function initElements() {
            elements.settingsModal = document.getElementById('settingsModal');
            elements.watchlistTags = document.getElementById('watchlistTags');
            elements.scanLimit = document.getElementById('scanLimit');
            elements.maxLimit = document.getElementById('maxLimit');
            elements.newWatchlistItem = document.getElementById('newWatchlistItem');
            elements.watchlistDisplay = document.getElementById('watchlistDisplay');
        }

        let currentWatchlist = {{ watchlist|tojson }};
        let currentLensConfigs = {};
        let currentLensTab = 'SALES';
        let currentScanLimit = 3;  // Default: 3 calls for simple demo

        // Load watchlist on page load
        async function loadWatchlist() {
            try {
                const res = await fetch('/api/watchlist');
                const data = await res.json();
                if(data.success) {
                    currentWatchlist = data.watchlist;
                    currentScanLimit = data.scan_limit || 5;
                    if(elements.scanLimit) elements.scanLimit.value = currentScanLimit;
                    renderWatchlistTags();
                }
            } catch(e) {
                console.error('Failed to load watchlist:', e);
            }
        }

        // Load lens configurations
        async function loadLensConfigs() {
            try {
                const res = await fetch('/api/lenses');
                const data = await res.json();
                if(data.success) {
                    data.lenses.forEach(lens => {
                        currentLensConfigs[lens.lens_name] = lens;
                    });
                    renderLensConfigs();
                }
            } catch(e) {
                console.error('Failed to load lens configs:', e);
            }
        }

        function renderLensConfigs() {
            ['SALES', 'MARKETING', 'PRODUCT'].forEach(lensName => {
                const config = currentLensConfigs[lensName] || {};

                // Set prompt
                const promptEl = document.getElementById(`${lensName.toLowerCase()}Prompt`);
                if(promptEl) promptEl.value = config.prompt_template || '';

                // Render schema fields
                renderSchemaFields(lensName, config.schema_fields || []);
            });
        }

        function renderSchemaFields(lensName, fields) {
            const container = document.getElementById(`${lensName.toLowerCase()}SchemaFields`);
            if(!container) return;

            container.innerHTML = '';

            fields.forEach((field, index) => {
                const fieldEl = createSchemaFieldElement(lensName, field, index);
                container.appendChild(fieldEl);
            });

            if(fields.length === 0) {
                container.innerHTML = '<p class="text-xs text-slate-300 italic">No fields defined. Click "Add Field" to create one.</p>';
            }
        }

        function createSchemaFieldElement(lensName, field, index) {
            const div = document.createElement('div');
            div.className = 'bg-slate-900/50 p-2 rounded border border-slate-700';

            // Escape HTML to prevent XSS
            const escapeHtml = (str) => (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            const name = escapeHtml(field.name || '');
            const desc = escapeHtml(field.description || '');
            const literalVals = field.literal_values ? escapeHtml(field.literal_values.join(', ')) : '';
            const isLiteral = field.type === 'Literal';

            div.innerHTML = `
                <div class="grid grid-cols-12 gap-2 items-center">
                    <div class="col-span-4">
                        <input type="text"
                            class="schema-field-name w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-xs text-slate-200 focus:outline-none focus:border-blue-500"
                            placeholder="name"
                            value="${name}"
                            data-lens="${lensName}"
                            data-index="${index}"
                            data-field="name"
                            onchange="updateSchemaField('${lensName}', ${index})"
                        >
                    </div>
                    <div class="col-span-2">
                        <select class="schema-field-type w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-xs text-slate-200 focus:outline-none focus:border-blue-500"
                            data-lens="${lensName}"
                            data-index="${index}"
                            data-field="type"
                            onchange="updateSchemaField('${lensName}', ${index})"
                        >
                            <option value="str" ${field.type === 'str' ? 'selected' : ''}>str</option>
                            <option value="int" ${field.type === 'int' ? 'selected' : ''}>int</option>
                            <option value="bool" ${field.type === 'bool' ? 'selected' : ''}>bool</option>
                            <option value="List[str]" ${field.type === 'List[str]' ? 'selected' : ''}>List[str]</option>
                            <option value="Literal" ${isLiteral ? 'selected' : ''}>Literal</option>
                        </select>
                    </div>
                    <div class="col-span-5">
                        <input type="text"
                            class="schema-field-desc w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-xs text-slate-200 focus:outline-none focus:border-blue-500"
                            placeholder="description"
                            value="${desc}"
                            data-lens="${lensName}"
                            data-index="${index}"
                            data-field="description"
                            onchange="updateSchemaField('${lensName}', ${index})"
                        >
                    </div>
                    <div class="col-span-1">
                        <button onclick="removeSchemaField('${lensName}', ${index})"
                            class="w-full bg-red-600/20 hover:bg-red-600/40 text-red-400 px-2 py-1.5 rounded text-xs transition border border-red-800/50"
                            aria-label="Remove field">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
                ${isLiteral ? `
                    <div class="mt-2">
                        <input type="text"
                            class="schema-field-literal w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-slate-200 focus:outline-none focus:border-blue-500"
                            placeholder="Values (comma-separated)"
                            value="${literalVals}"
                            data-lens="${lensName}"
                            data-index="${index}"
                            onchange="updateSchemaField('${lensName}', ${index})"
                        >
                    </div>
                ` : ''}
            `;
            return div;
        }

        function updateSchemaField(lensName, index) {
            if(!currentLensConfigs[lensName] || !currentLensConfigs[lensName].schema_fields) return;

            const field = currentLensConfigs[lensName].schema_fields[index];
            if(!field) return;

            // Update from inputs
            const nameInput = document.querySelector(`input[data-lens="${lensName}"][data-index="${index}"][data-field="name"]`);
            const typeInput = document.querySelector(`select[data-lens="${lensName}"][data-index="${index}"][data-field="type"]`);
            const descInput = document.querySelector(`input[data-lens="${lensName}"][data-index="${index}"][data-field="description"]`);
            const literalInput = document.querySelector(`input[data-lens="${lensName}"][data-index="${index}"].schema-field-literal`);

            if(nameInput) field.name = nameInput.value;
            if(typeInput) {
                field.type = typeInput.value;
                // Re-render if type changed to show/hide literal input
                if(typeInput.value === 'Literal' || field.type === 'Literal') {
                    renderSchemaFields(lensName, currentLensConfigs[lensName].schema_fields);
                }
            }
            if(descInput) field.description = descInput.value;
            if(literalInput && field.type === 'Literal') {
                const values = literalInput.value.split(',').map(v => v.trim()).filter(v => v);
                field.literal_values = values;
            }
        }

        function addSchemaField(lensName) {
            if(!currentLensConfigs[lensName]) {
                currentLensConfigs[lensName] = {lens_name: lensName, schema_fields: []};
            }
            if(!currentLensConfigs[lensName].schema_fields) {
                currentLensConfigs[lensName].schema_fields = [];
            }

            currentLensConfigs[lensName].schema_fields.push({
                name: '',
                type: 'str',
                description: '',
                default: null
            });

            renderSchemaFields(lensName, currentLensConfigs[lensName].schema_fields);
        }

        function removeSchemaField(lensName, index) {
            if(currentLensConfigs[lensName] && currentLensConfigs[lensName].schema_fields) {
                currentLensConfigs[lensName].schema_fields.splice(index, 1);
                renderSchemaFields(lensName, currentLensConfigs[lensName].schema_fields);
            }
        }

        let currentMainTab = 'watchlist';

        // Cache tab elements
        const tabElements = {
            watchlistTab: null,
            lensesTab: null,
            watchlistContent: null,
            lensesContent: null
        };

        function initTabElements() {
            tabElements.watchlistTab = document.getElementById('mainTabWatchlist');
            tabElements.lensesTab = document.getElementById('mainTabLenses');
            tabElements.watchlistContent = document.getElementById('tabContentWatchlist');
            tabElements.lensesContent = document.getElementById('tabContentLenses');
        }

        function switchMainTab(tabName) {
            if(!tabElements.watchlistTab) initTabElements();

            const active = tabName === 'watchlist';
            const inactive = !active;

            // Update watchlist tab
            if(tabElements.watchlistTab) {
                if(active) {
                    tabElements.watchlistTab.classList.add('border-blue-500', 'text-blue-400');
                    tabElements.watchlistTab.classList.remove('border-transparent', 'text-slate-400');
                } else {
                    tabElements.watchlistTab.classList.remove('border-blue-500', 'text-blue-400');
                    tabElements.watchlistTab.classList.add('border-transparent', 'text-slate-400');
                }
            }

            // Update lenses tab
            if(tabElements.lensesTab) {
                if(inactive) {
                    tabElements.lensesTab.classList.add('border-blue-500', 'text-blue-400');
                    tabElements.lensesTab.classList.remove('border-transparent', 'text-slate-400');
                } else {
                    tabElements.lensesTab.classList.remove('border-blue-500', 'text-blue-400');
                    tabElements.lensesTab.classList.add('border-transparent', 'text-slate-400');
                }
            }

            // Update content
            if(tabElements.watchlistContent) {
                tabElements.watchlistContent.classList.toggle('hidden', !active);
            }
            if(tabElements.lensesContent) {
                tabElements.lensesContent.classList.toggle('hidden', active);
            }
        }

        function switchLensTab(lensName) {
            currentLensTab = lensName;

            ['SALES', 'MARKETING', 'PRODUCT'].forEach(name => {
                const tab = document.getElementById(`tab${name}`);
                const panel = document.getElementById(`lensConfig${name}`);
                if(!tab || !panel) return;

                const isActive = name === lensName;

                // Reset all tab styles
                tab.classList.remove('border-amber-500', 'text-amber-400', 'border-cyan-500', 'text-cyan-400', 'border-green-500', 'text-green-400', 'border-transparent', 'text-slate-400');

                if (isActive) {
                    if (name === 'SALES') {
                        tab.classList.add('border-amber-500', 'text-amber-400');
                    } else if (name === 'MARKETING') {
                        tab.classList.add('border-cyan-500', 'text-cyan-400');
                    } else if (name === 'PRODUCT') {
                        tab.classList.add('border-green-500', 'text-green-400');
                    }
                } else {
                    tab.classList.add('border-transparent', 'text-slate-400');
                }

                panel.classList.toggle('hidden', !isActive);
            });
        }

        function renderWatchlistTags() {
            if(!elements.watchlistTags) return;
            const container = elements.watchlistTags;
            container.innerHTML = '';

            currentWatchlist.forEach((tag, index) => {
                const tagEl = document.createElement('div');
                tagEl.className = 'flex items-center gap-2 bg-blue-900/30 text-blue-300 px-3 py-1.5 rounded-lg border border-blue-800/50 text-sm';
                tagEl.innerHTML = `
                    <span>${tag}</span>
                    <button onclick="removeWatchlistItem(${index})" class="text-blue-400 hover:text-red-400 transition" aria-label="Remove ${tag}">
                        <i class="fa-solid fa-times text-xs"></i>
                    </button>
                `;
                container.appendChild(tagEl);
            });

            if(elements.watchlistDisplay) {
                elements.watchlistDisplay.textContent = currentWatchlist.join(', ');
            }
        }

        function addWatchlistItem() {
            if(!elements.newWatchlistItem) return;
            const value = elements.newWatchlistItem.value.trim();
            if(value && !currentWatchlist.includes(value)) {
                currentWatchlist.push(value);
                renderWatchlistTags();
                elements.newWatchlistItem.value = '';
            }
        }

        function removeWatchlistItem(index) {
            currentWatchlist.splice(index, 1);
            renderWatchlistTags();
        }

        function openSettings() {
            if(elements.settingsModal) {
                elements.settingsModal.classList.remove('hidden');
                loadWatchlist();
                loadLensConfigs();
            }
        }

        function closeSettings() {
            if(elements.settingsModal) {
                elements.settingsModal.classList.add('hidden');
            }
        }

        async function saveSettings() {
            try {
                // Collect lens configs from UI
                ['SALES', 'MARKETING', 'PRODUCT'].forEach(lensName => {
                    const promptEl = document.getElementById(`${lensName.toLowerCase()}Prompt`);
                    if(!promptEl) return;

                    const prompt = promptEl.value;

                    if(!currentLensConfigs[lensName]) {
                        currentLensConfigs[lensName] = {lens_name: lensName, schema_fields: []};
                    }

                    currentLensConfigs[lensName].prompt_template = prompt;

                    if(!currentLensConfigs[lensName].schema_fields) {
                        currentLensConfigs[lensName].schema_fields = [];
                    }

                    // Update all fields from UI before saving
                    currentLensConfigs[lensName].schema_fields.forEach((field, index) => {
                        updateSchemaField(lensName, index);
                    });

                    // Filter out empty fields
                    currentLensConfigs[lensName].schema_fields = currentLensConfigs[lensName].schema_fields.filter(f => f.name && f.name.trim());
                });

                // Save watchlist and search config
                const scanLimit = elements.scanLimit ? parseInt(elements.scanLimit.value) || 5 : 5;

                const watchlistRes = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCookie('csrf_token')
                    },
                    body: JSON.stringify({
                        watchlist: currentWatchlist,
                        scan_limit: scanLimit
                    })
                });

                const watchlistData = await watchlistRes.json();
                if(!watchlistData.success) {
                    alert('Failed to save watchlist: ' + (watchlistData.error || 'Unknown error'));
                    return;
                }

                // Save lens configs
                let allSaved = true;
                for(const [lensName, config] of Object.entries(currentLensConfigs)) {
                    const lensRes = await fetch(`/api/lenses/${lensName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': getCookie('csrf_token')
                        },
                        body: JSON.stringify(config)
                    });

                    const lensData = await lensRes.json();
                    if(!lensData.success) {
                        console.error(`Failed to save ${lensName}:`, lensData.error);
                        allSaved = false;
                    }
                }

                if(allSaved) {
                    closeSettings();
                    alert('Configuration saved! Changes will take effect on the next scan.');
                    location.reload();
                } else {
                    alert('Some lens configurations failed to save. Check console for details.');
                }
            } catch(e) {
                console.error(e);
                alert('Failed to save configuration: ' + e.message);
            }
        }

        let wsConnection = null;
        let isScanning = false;

        // Function to render a report card from data
        function renderReportCard(report) {
            const container = document.getElementById('reportsContainer');
            if (!container) return;

            // Format timestamp
            const timestamp = report.timestamp ? new Date(report.timestamp).toISOString().split('T')[0] : 'Unknown';
            const isFresh = report.is_fresh || false;

            // Build matched keywords HTML
            let keywordsHTML = '';
            if (report.matched_keywords && report.matched_keywords.length > 0) {
                keywordsHTML = report.matched_keywords.map(kw =>
                    `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[11px] font-semibold bg-gradient-to-r from-green-600/20 to-emerald-600/20 text-green-300 border border-green-500/40 uppercase tracking-wide shadow-sm hover:shadow-md hover:border-green-500/60 transition-all duration-200">
                        <i class="fa-solid fa-tag text-[9px]"></i>${kw}
                    </span>`
                ).join('');
            }

            const cardHTML = `
                <div class="group relative glass-enhanced border border-slate-800 rounded-2xl overflow-hidden hover:border-slate-700 transition duration-500 shadow-2xl animate-fade-in">
                    <!-- Enhanced Card Header -->
                    <div class="relative bg-gradient-to-br from-slate-800/60 via-slate-800/50 to-slate-900/50 p-4 border-b border-slate-700/80 backdrop-blur-sm">
                        <!-- Header Top Row: Source Detected + Matched Keywords -->
                        <div class="flex items-center justify-between gap-3 mb-3 flex-wrap">
                            <!-- Left: Source Detected + Matched Keywords -->
                            <div class="flex items-center gap-3 flex-wrap flex-1">
                                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-semibold bg-blue-500/15 text-blue-300 border border-blue-500/40 uppercase tracking-wider backdrop-blur-sm">
                                    <i class="fa-solid fa-radar text-[10px]"></i>Source Detected
                                </span>
                                ${keywordsHTML ? `<div class="flex items-center gap-2 flex-wrap">${keywordsHTML}</div>` : ''}
                            </div>

                            <!-- Right: NEW Badge + Timestamp + View Memories Button -->
                            <div class="flex items-center gap-3">
                                ${(() => {
                                    const company = report.customer_company || 
                                        (report.repo_name && report.repo_name.includes(' - ') 
                                            ? report.repo_name.split(' - ')[0] 
                                            : 'unknown');
                                    return `
                                <div class="relative group">
                                    <button onclick="showCustomerMemories('${company}', '${report.call_id || report.repo_id}')" 
                                        class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-semibold bg-gradient-to-r from-blue-600/20 to-indigo-600/20 text-blue-300 border border-blue-500/40 hover:from-blue-600/30 hover:to-indigo-600/30 hover:border-blue-500/60 transition-all duration-200 cursor-pointer"
                                        title="View per-call memories - insights extracted using Mem0 (memory-only, no RAG)">
                                        <i class="fa-solid fa-brain text-[10px]"></i>View Memories
                                    </button>
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-2 bg-slate-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-blue-500/40">
                                        <div class="flex items-start gap-2">
                                            <i class="fa-solid fa-brain text-blue-400 mt-0.5"></i>
                                            <div>
                                                <div class="font-semibold text-blue-300 mb-1">Per-Call Memories (Mem0)</div>
                                                <div class="text-slate-300">Memories extracted from this specific call using Mem0. Memory-only approach - no RAG/vector search.</div>
                                            </div>
                                        </div>
                                        <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-800"></div>
                                    </div>
                                </div>
                                `;
                                })()}
                                ${isFresh ? `<span class="new-badge inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-bold bg-gradient-to-r from-green-600/90 to-emerald-600/90 text-white border border-green-500/60 uppercase tracking-wider shadow-lg shadow-green-500/30 backdrop-blur-sm">
                                    <i class="fa-solid fa-sparkles text-[10px]"></i>NEW
                                </span>` : ''}
                                <div class="flex items-center gap-2 text-xs text-slate-300">
                                    <i class="fa-solid fa-clock text-[10px]"></i>
                                    <time datetime="${report.timestamp || ''}" class="font-mono">${timestamp}</time>
                                </div>
                            </div>
                        </div>

                        <!-- Title Section -->
                        <div class="mb-3">
                            <div class="group block">
                                <h2 class="text-lg font-bold text-white leading-snug pr-6">
                                    ${report.original_title || report.repo_name || 'Unknown'}
                                </h2>
                                <div class="flex items-center gap-3 mt-2 text-xs text-slate-400 flex-wrap">
                                    ${report.repo_name && report.repo_name.includes(' - ') ? (() => {
                                        const parts = report.repo_name.split(' - ');
                                        return `
                                    <span class="flex items-center gap-1">
                                                <i class="fa-solid fa-building text-cyan-400"></i>
                                                ${parts[0]}
                                    </span>
                                    <span class="flex items-center gap-1">
                                                <i class="fa-solid fa-phone text-blue-400"></i>
                                                ${parts[1] || 'Call'}
                                    </span>
                                        `;
                                    })() : ''}
                                    ${report.repo_owner ? `<span class="flex items-center gap-1">
                                        <i class="fa-solid fa-user text-green-400"></i>
                                        ${report.repo_owner}
                                    </span>` : ''}
                                    ${report.timestamp ? `<span class="flex items-center gap-1">
                                        <i class="fa-solid fa-clock text-yellow-400"></i>
                                        ${report.timestamp.substring(0, 10) || 'Unknown'}
                                    </span>` : ''}
                                </div>
                                    </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-slate-800">
                        <!-- SALES Lens -->
                        <div class="p-4 hover:bg-slate-800/30 transition lens-card">
                            <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700/50">
                                <div class="flex items-center gap-1.5 text-amber-400">
                                    <i class="fa-solid fa-dollar-sign text-xs"></i>
                                    <h3 class="text-xs font-bold uppercase tracking-wider">SALES</h3>
                                </div>
                                ${report.sales?.closing_probability ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded ${
                                    report.sales.closing_probability === 'High' ? 'bg-green-500/20 text-green-400 border border-green-800/50' :
                                    report.sales.closing_probability === 'Medium' ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-800/50' :
                                    'bg-slate-500/20 text-slate-400 border border-slate-700/50'
                                }">${report.sales.closing_probability}</span>` : ''}
                            </div>
                            <div class="space-y-3">
                                ${report.sales ? `
                                    ${report.sales.deal_value ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Deal Value</p>
                                        <p class="text-xs text-slate-300 leading-relaxed">${report.sales.deal_value}</p>
                                    </div>` : ''}
                                    ${report.sales.decision_stage ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Decision Stage</p>
                                        <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-500/20 text-blue-400 border border-blue-800/50">
                                            ${report.sales.decision_stage}
                                </span>
                                    </div>` : ''}
                                    ${report.sales.products_discussed && report.sales.products_discussed.length > 0 ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Products Discussed</p>
                                        <div class="flex flex-wrap gap-1.5 mt-1">
                                            ${report.sales.products_discussed.map(p => `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-semibold bg-green-600/20 text-green-300 border border-green-500/40">${p}</span>`).join('')}
                            </div>
                                    </div>` : ''}
                                    ${report.sales.key_insight ? `<div>
                                    <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Key Insight</p>
                                        <p class="text-xs text-slate-300 leading-relaxed">${report.sales.key_insight}</p>
                                    </div>` : ''}
                                ` : '<p class="text-xs text-slate-400 italic">No sales analysis available</p>'}
                            </div>
                        </div>

                        <!-- MARKETING Lens -->
                        <div class="p-4 hover:bg-slate-800/30 transition lens-card">
                            <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700/50">
                                <div class="flex items-center gap-1.5 text-cyan-400">
                                    <i class="fa-solid fa-bullhorn text-xs"></i>
                                    <h3 class="text-xs font-bold uppercase tracking-wider">MARKETING</h3>
                                </div>
                                ${report.marketing?.customer_sentiment ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded ${
                                    report.marketing.customer_sentiment.includes('Very Positive') || report.marketing.customer_sentiment === 'Positive' ? 'bg-green-500/20 text-green-400 border border-green-800/50' :
                                    report.marketing.customer_sentiment.includes('Very Negative') || report.marketing.customer_sentiment === 'Negative' ? 'bg-red-500/20 text-red-400 border border-red-800/50' :
                                    'bg-slate-500/20 text-slate-400 border border-slate-700/50'
                                }">${report.marketing.customer_sentiment}</span>` : ''}
                                ${report.marketing?.engagement_level ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded ml-2 ${
                                    report.marketing.engagement_level.includes('Very High') || report.marketing.engagement_level === 'High' ? 'bg-blue-500/20 text-blue-400 border border-blue-800/50' :
                                    report.marketing.engagement_level.includes('Very Low') || report.marketing.engagement_level === 'Low' ? 'bg-slate-500/20 text-slate-400 border border-slate-700/50' :
                                    'bg-slate-500/20 text-slate-400 border border-slate-700/50'
                                }">${report.marketing.engagement_level}</span>` : ''}
                            </div>
                            <div class="space-y-3">
                                ${report.marketing ? `
                                    ${report.marketing.messaging_resonance && report.marketing.messaging_resonance !== 'Not clearly evident' ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Messaging Resonance</p>
                                        <p class="text-xs text-slate-300 leading-relaxed">${report.marketing.messaging_resonance}</p>
                                    </div>` : ''}
                                    ${report.marketing.brand_perception && report.marketing.brand_perception !== 'Not discussed' ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Brand Perception</p>
                                        <p class="text-xs text-slate-300 leading-relaxed">${report.marketing.brand_perception}</p>
                                    </div>` : ''}
                                    ${report.marketing.customer_language && report.marketing.customer_language !== 'Not evident' ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Customer Language</p>
                                        <p class="text-xs text-slate-300 leading-relaxed italic">${report.marketing.customer_language}</p>
                                    </div>` : ''}
                                    ${report.marketing.competitive_mentions && report.marketing.competitive_mentions.length > 0 ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Competitors Mentioned</p>
                                        <div class="flex flex-wrap gap-1.5 mt-1">
                                            ${report.marketing.competitive_mentions.map(c => `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-semibold bg-red-600/20 text-red-300 border border-red-500/40">${c}</span>`).join('')}
                                </div>
                                    </div>` : ''}
                                    ${report.marketing.pain_points_mentioned && report.marketing.pain_points_mentioned.length > 0 ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Pain Points Mentioned</p>
                                        <ul class="text-xs text-slate-300 space-y-1">
                                            ${report.marketing.pain_points_mentioned.map(p => `<li class="flex items-start gap-1"><i class="fa-solid fa-exclamation-triangle text-[6px] mt-1.5 text-orange-400"></i><span>${p}</span></li>`).join('')}
                                        </ul>
                                    </div>` : ''}
                                    ${report.marketing.key_insight ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Key Insight</p>
                                        <p class="text-xs text-slate-300 leading-relaxed">${report.marketing.key_insight}</p>
                                    </div>` : ''}
                                ` : '<p class="text-xs text-slate-400 italic">No marketing analysis available</p>'}
                                </div>
                            </div>

                        <!-- PRODUCT Lens -->
                        <div class="p-4 hover:bg-slate-800/30 transition lens-card">
                            <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-700/50">
                                <div class="flex items-center gap-1.5 text-green-400">
                                    <i class="fa-solid fa-box text-xs"></i>
                                    <h3 class="text-xs font-bold uppercase tracking-wider">PRODUCT</h3>
                                </div>
                                ${report.product?.product_fit_score ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded ${
                                    report.product.product_fit_score === 'Excellent' ? 'bg-green-500/20 text-green-400 border border-green-800/50' :
                                    report.product.product_fit_score === 'Good' ? 'bg-blue-500/20 text-blue-400 border border-blue-800/50' :
                                    report.product.product_fit_score === 'Fair' ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-800/50' :
                                    'bg-red-500/20 text-red-400 border border-red-800/50'
                                }">${report.product.product_fit_score}</span>` : ''}
                                </div>
                            <div class="space-y-3">
                                ${report.product ? `
                                    ${report.product.feature_requests && report.product.feature_requests.length > 0 ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Feature Requests</p>
                                        <ul class="text-xs text-slate-300 space-y-1">
                                            ${report.product.feature_requests.map(f => `<li class="flex items-start gap-1"><i class="fa-solid fa-lightbulb text-[6px] mt-1.5 text-green-400"></i><span>${f}</span></li>`).join('')}
                                        </ul>
                                    </div>` : ''}
                                    ${report.product.pain_points && report.product.pain_points.length > 0 ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Pain Points</p>
                                        <ul class="text-xs text-slate-300 space-y-1">
                                            ${report.product.pain_points.map(p => `<li class="flex items-start gap-1"><i class="fa-solid fa-exclamation-triangle text-[6px] mt-1.5 text-orange-400"></i><span>${p}</span></li>`).join('')}
                                        </ul>
                                    </div>` : ''}
                                    ${report.product.key_insight ? `<div>
                                        <p class="text-[10px] text-slate-300 uppercase font-semibold mb-1">Key Insight</p>
                                        <p class="text-xs text-slate-300 leading-relaxed">${report.product.key_insight}</p>
                                    </div>` : ''}
                                ` : '<p class="text-xs text-slate-400 italic">No product analysis available</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Create element and add with animation
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cardHTML.trim();
            const cardElement = tempDiv.firstElementChild;

            // Remove the parallax-card class that sets opacity: 0
            cardElement.classList.remove('parallax-card');
            // Add animation class
            cardElement.classList.add('animate-fade-in');

            // Force visibility with inline styles (overrides any CSS)
            cardElement.style.setProperty('opacity', '1', 'important');
            cardElement.style.setProperty('transform', 'translateY(0)', 'important');

            // Insert at the top of container
            if (container.firstChild) {
                container.insertBefore(cardElement, container.firstChild);
            } else {
                container.appendChild(cardElement);
            }

            // Scroll to top smoothly if needed
            setTimeout(() => {
                cardElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function getUrgencyClass(urgency) {
            if (urgency === 'High') return 'bg-orange-500/20 text-orange-400 border border-orange-800/50';
            if (urgency === 'Medium') return 'bg-yellow-500/20 text-yellow-400 border border-yellow-800/50';
            return 'bg-slate-500/20 text-slate-400 border border-slate-700/50';
        }

        function getComplexityClass(complexity) {
            if (complexity === 'High') return 'bg-red-500/20 text-red-400 border border-red-800/50';
            if (complexity === 'Medium') return 'bg-yellow-500/20 text-yellow-400 border border-yellow-800/50';
            return 'bg-green-500/20 text-green-400 border border-green-800/50';
        }

        function getReadinessClass(readiness) {
            if (readiness === 'Production') return 'bg-green-500/20 text-green-400 border border-green-800/50';
            if (readiness === 'Beta') return 'bg-blue-500/20 text-blue-400 border border-blue-800/50';
            return 'bg-orange-500/20 text-orange-400 border border-orange-800/50';
        }

        async function refreshData() {
            if(isScanning) {
                showNotification('Scan already in progress', 'info');
                return;
            }

            const btn = document.getElementById('refreshBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Scanning...';
            btn.disabled = true;
            isScanning = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            // Remove empty state if present
            const emptyState = document.querySelector('.text-center.py-20');
            if (emptyState) {
                emptyState.style.display = 'none';
            }

            // Reports container removed - focusing on calls only
            // Analysis results are shown per-call in the transcripts view

            // Create elegant progress indicator
            const progressDiv = document.createElement('div');
            progressDiv.id = 'scanProgress';
            progressDiv.className = 'fixed top-20 right-6 bg-slate-900/95 backdrop-blur-md border border-slate-700/50 rounded-xl shadow-2xl z-50 p-5 min-w-[320px] max-w-[400px] animate-slide-in-right';
            progressDiv.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-circle-notch fa-spin text-blue-400"></i>
                        <span class="text-white font-semibold text-sm">Analyzing Calls</span>
                    </div>
                    <button onclick="closeProgressModal()" class="text-slate-400 hover:text-white transition-all hover:scale-110 rounded p-1">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div class="text-sm text-slate-300 mb-3" id="scanProgressText">Initializing search...</div>
                <div class="mb-2 bg-slate-800 rounded-full h-2.5 overflow-hidden shadow-inner">
                    <div id="scanProgressBar" class="progress-glow bg-gradient-to-r from-blue-500 via-cyan-500 to-purple-500 h-2.5 rounded-full transition-all duration-500 ease-out shimmer" style="width: 0%"></div>
                </div>
                <div class="text-xs text-slate-400 mt-2" id="scanProgressStats">0 calls analyzed</div>
            `;
            document.body.appendChild(progressDiv);

            try {
                // Connect to WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/scan`;
                wsConnection = new WebSocket(wsUrl);

                wsConnection.onopen = () => {
                    console.log('WebSocket connected');
                    wsConnection.send(JSON.stringify({action: 'start_scan'}));
                };

                wsConnection.onmessage = async (event) => {
                    const data = JSON.parse(event.data);
                    const progressText = document.getElementById('scanProgressText');
                    const progressBar = document.getElementById('scanProgressBar');
                    const progressStats = document.getElementById('scanProgressStats');

                    if(data.type === 'scan_started') {
                        progressText.textContent = 'Analyzing call transcripts...';
                        progressBar.style.width = '5%';
                        progressStats.textContent = '0 calls analyzed';
                    } else if(data.type === 'report_complete') {
                        const {repo_id, repo_name, total_processed, total_found} = data;

                        // Update progress UI
                        progressText.innerHTML = `
                            <span class="text-green-400"></span>
                            <strong class="text-white">${repo_name}</strong>
                        `;
                        const progress = total_found > 0 ? Math.min(95, (total_processed / total_found) * 95) : 50;
                        progressBar.style.width = `${progress}%`;
                        progressStats.textContent = `${total_processed}/${total_found} calls analyzed`;

                        // Fetch and render the report card immediately (with small delay to ensure DB write completes)
                        setTimeout(async () => {
                            try {
                        // Use encodeURIComponent to properly encode the call_id/repo_id
                                const encodedRepoId = encodeURIComponent(repo_id);
                                const response = await fetch(`/api/reports/${encodedRepoId}`);
                                if (response.ok) {
                                    const result = await response.json();
                                    if (result.success && result.report) {
                                        renderReportCard(result.report);
                                        showNotification(` ${repo_name} analyzed`, 'success');
                                    }
                                } else {
                                    // Log error for debugging
                                    const errorData = await response.json().catch(() => ({}));
                                    console.error(`Failed to fetch report for ${repo_id}:`, response.status, errorData);
                                    // Retry once after a longer delay (DB might need more time)
                                    setTimeout(async () => {
                                        try {
                                            const retryResponse = await fetch(`/api/reports/${encodedRepoId}`);
                                            if (retryResponse.ok) {
                                                const retryResult = await retryResponse.json();
                                                if (retryResult.success && retryResult.report) {
                                                    renderReportCard(retryResult.report);
                                                }
                                            }
                                        } catch (e) {
                                            console.error('Retry failed:', e);
                                        }
                                    }, 1000);
                                }
                            } catch (e) {
                                console.error('Error fetching report:', e);
                            }
                        }, 500); // Small delay to ensure DB write completes
                    } else if(data.type === 'analysis_complete' || data.type === 'scan_complete') {
                        progressText.innerHTML = `<span class="text-green-400"></span> <strong class="text-white">Complete!</strong>`;
                        progressBar.style.width = '100%';
                        progressStats.textContent = `${data.total_reports || 0} calls analyzed`;
                        showNotification(`Analysis complete: ${data.total_reports || 0} calls`, 'success');

                        // Close progress modal after delay
                        setTimeout(() => {
                            closeProgressModal();
                            btn.innerHTML = originalHTML;
                            btn.disabled = false;
                            isScanning = false;
                        btn.classList.remove('opacity-75', 'cursor-not-allowed');
                        }, 2000);
                    } else if(data.type === 'error') {
                        progressText.innerHTML = `<span class="text-red-400"></span> <span class="text-white">${data.message}</span>`;
                        showNotification(data.message, 'error');
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                        isScanning = false;
                        btn.classList.remove('opacity-75', 'cursor-not-allowed');
                        setTimeout(() => closeProgressModal(), 3000);
                    }
                };

                wsConnection.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    showNotification('Connection error. Falling back to regular scan...', 'error');
                    fallbackRefresh();
                };

                wsConnection.onclose = () => {
                    console.log('WebSocket closed');
                    if (!isScanning) return; // Already handled
                        setTimeout(() => {
                        closeProgressModal();
                    }, 1000);
                };

            } catch(e) {
                console.error('WebSocket setup error:', e);
                showNotification('WebSocket not available. Using fallback...', 'info');
                fallbackRefresh();
            }
        }

        function closeProgressModal() {
            const progressDiv = document.getElementById('scanProgress');
            if (progressDiv) {
                progressDiv.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => progressDiv.remove(), 300);
            }
        }

        async function fallbackRefresh() {
            const btn = document.getElementById('refreshBtn');
            const originalHTML = btn.innerHTML;

            try {
                const res = await fetch('/api/refresh', {
                    method: 'POST',
                    headers: { 'X-CSRF-Token': getCookie('csrf_token') }
                });
                const data = await res.json();
                if(data.success) {
                    showNotification(data.message || 'Scan complete', data.status === 'no_new' ? 'info' : 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showNotification(`Scan failed: ${data.error || 'Unknown error'}`, 'error');
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    isScanning = false;
                }
            } catch(e) {
                showNotification(`Scan error: ${e.message}`, 'error');
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                isScanning = false;
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg border backdrop-blur-sm slide-in ${
                type === 'info' ? 'bg-blue-900/80 border-blue-700 text-blue-200' :
                type === 'success' ? 'bg-green-900/80 border-green-700 text-green-200' :
                'bg-red-900/80 border-red-700 text-red-200'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid ${type === 'info' ? 'fa-info-circle' : type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // View switching (Transcripts only - simplified demo)
        // switchView removed - transcripts section removed, only Master Memory tabs remain

        // Toggle transcript visibility
        function toggleTranscript(callId) {
            const content = document.getElementById(`transcriptContent-${callId}`);
            const icon = document.getElementById(`transcriptIcon-${callId}`);
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }


        // Load and display analysis results for a call
        async function loadAndShowAnalysis(callId) {
            try {
                const response = await fetch(`/api/reports/${encodeURIComponent(callId)}`);
                const data = await response.json();
                
                if (data.success && data.report) {
                    const report = data.report;
                    const card = document.querySelector(`[data-call-id="${callId}"]`);
                    if (!card) return;
                    
                    // Find or create analysis display section
                    let analysisDisplay = card.querySelector(`#analysisDisplay-${callId}`);
                    if (!analysisDisplay) {
                        const analysisSection = card.querySelector(`#analysisResults-${callId}`);
                        if (analysisSection) {
                            analysisDisplay = document.createElement('div');
                            analysisDisplay.id = `analysisDisplay-${callId}`;
                            analysisDisplay.className = 'mt-4 p-4 bg-slate-900/50 rounded-lg border border-slate-700/50';
                            analysisSection.parentNode.insertBefore(analysisDisplay, analysisSection.nextSibling);
                        } else {
                            return;
                        }
                    }
                    
                    // Build simplified analysis HTML - focus on Master Memory
                    let analysisHTML = '<div class="space-y-4">';
                    analysisHTML += '<div class="p-4 bg-purple-500/10 border border-purple-500/30 rounded-lg mb-4">';
                    analysisHTML += '<div class="flex items-center gap-2 mb-2"><i class="fa-solid fa-brain text-purple-400"></i><span class="text-sm font-bold text-purple-300">Master Memory</span></div>';
                    analysisHTML += '<p class="text-xs text-slate-300 mb-3">Insights from this call have been added to Master Memory. View Master Memory for cross-call patterns and intelligence.</p>';
                    analysisHTML += '<button onclick="showMasterMemory()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-xs font-semibold transition-all">View Master Memory</button>';
                    analysisHTML += '</div>';
                    analysisHTML += '<h4 class="text-xs font-bold text-slate-400 mb-2 uppercase">Call Analysis Summary</h4>';
                    
                    // Simplified summary only
                    if (report.sales && report.sales.key_insight) {
                        analysisHTML += '<div class="p-2 bg-slate-800/50 border border-slate-700/50 rounded text-xs text-slate-300 mb-2">';
                        analysisHTML += `<strong class="text-amber-300">Sales:</strong> ${report.sales.key_insight.substring(0, 150)}${report.sales.key_insight.length > 150 ? '...' : ''}`;
                        analysisHTML += '</div>';
                    }
                    
                    if (report.marketing && report.marketing.key_insight) {
                        analysisHTML += '<div class="p-2 bg-slate-800/50 border border-slate-700/50 rounded text-xs text-slate-300 mb-2">';
                        analysisHTML += `<strong class="text-cyan-300">Marketing:</strong> ${report.marketing.key_insight.substring(0, 150)}${report.marketing.key_insight.length > 150 ? '...' : ''}`;
                        analysisHTML += '</div>';
                    }
                    
                    if (report.product && report.product.key_insight) {
                        analysisHTML += '<div class="p-2 bg-slate-800/50 border border-slate-700/50 rounded text-xs text-slate-300 mb-2">';
                        analysisHTML += `<strong class="text-green-300">Product:</strong> ${report.product.key_insight.substring(0, 150)}${report.product.key_insight.length > 150 ? '...' : ''}`;
                        analysisHTML += '</div>';
                    }
                    
                    // Remove the old detailed lens display
                    if (false) {
                        // SALES Lens (removed)
                    }
                    
                    // MARKETING Lens (removed)
                    if (false) {
                    }
                    
                    // PRODUCT Lens (removed)
                    if (false) {
                        analysisHTML += '<div class="flex items-center gap-2 mb-2"><i class="fa-solid fa-cube text-green-400"></i><span class="text-xs font-bold text-green-300 uppercase">PRODUCT</span></div>';
                        if (report.product.feature_requests && Array.isArray(report.product.feature_requests) && report.product.feature_requests.length > 0) {
                            analysisHTML += `<p class="text-xs text-slate-300 mb-1"><strong>Feature Requests:</strong> ${report.product.feature_requests.join(', ')}</p>`;
                        }
                        if (report.product.pain_points && Array.isArray(report.product.pain_points) && report.product.pain_points.length > 0) {
                            analysisHTML += `<p class="text-xs text-slate-300 mb-1"><strong>Pain Points:</strong> ${report.product.pain_points.join(', ')}</p>`;
                        }
                        if (report.product.key_insight) analysisHTML += `<p class="text-xs text-slate-300 mt-2 italic">${report.product.key_insight}</p>`;
                        analysisHTML += '</div>';
                    }
                    
                    // Add action buttons - emphasize Master Memory
                    analysisHTML += '<div class="flex gap-2 mt-4 pt-4 border-t border-slate-700">';
                    analysisHTML += '<button onclick="showMasterMemory()" class="text-xs px-3 py-1.5 bg-purple-600/20 hover:bg-purple-600/30 text-purple-300 rounded transition-all">';
                    analysisHTML += '<i class="fa-solid fa-brain mr-1"></i>View Master Memory</button>';
                    const company = report.customer_company || (report.repo_name && report.repo_name.split(' - ')[0]) || 'unknown';
                    analysisHTML += `<button onclick="showCustomerMemories('${company}', '${callId}')" class="text-xs px-3 py-1.5 bg-blue-600/20 hover:bg-blue-600/30 text-blue-300 rounded transition-all" title="View per-call memories">`;
                    analysisHTML += '<i class="fa-solid fa-memory mr-1"></i>Per-Call Memories</button>';
                    analysisHTML += '</div>';
                    
                    analysisHTML += '</div>';
                    analysisDisplay.innerHTML = analysisHTML;
                    analysisDisplay.classList.remove('hidden');
                }
            } catch (e) {
                console.error(`Failed to load analysis for ${callId}:`, e);
            }
        }

        // Show analysis progress modal
        function showAnalysisProgress(callId) {
            // Remove existing progress modal if any
            const existing = document.getElementById('analysisProgressModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'analysisProgressModal';
            modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-2xl w-full p-6 animate-scale-in">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-brain text-blue-400"></i>
                            AI Analysis Progress
                        </h3>
                        <button onclick="closeAnalysisProgress()" class="text-slate-400 hover:text-white transition-all hover:scale-110 rounded p-1">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-3 mb-4" id="progressSteps">
                        <!-- Steps will be added here -->
                    </div>
                    <div class="mt-6 bg-slate-800 rounded-full h-2 overflow-hidden">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 via-cyan-500 to-purple-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Define steps
            const steps = [
                { stage: 'transcript_loaded', label: 'Transcript loaded and parsed', icon: 'fa-file-text' },
                { stage: 'retrieving_memory_context', label: 'Retrieving relevant memories', icon: 'fa-brain' },
                { stage: 'lens_analysis_started', label: 'Analyzing through SALES, MARKETING, PRODUCT lenses', icon: 'fa-eye' },
                { stage: 'lens_analysis_complete', label: 'Multi-lens analysis complete', icon: 'fa-check-circle' },
                { stage: 'extracting_memories', label: 'Extracting memories using Mem0', icon: 'fa-memory' },
                { stage: 'memories_stored', label: 'Memories stored in Master Memory', icon: 'fa-database' },
                { stage: 'complete', label: 'Analysis complete!', icon: 'fa-check-double' }
            ];
            
            // Render steps
            const stepsContainer = document.getElementById('progressSteps');
            steps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.id = `step-${step.stage}`;
                stepDiv.className = 'flex items-center gap-3 p-3 rounded-lg bg-slate-800/50 border border-slate-700/50';
                stepDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center">
                        <i class="fa-solid ${step.icon} text-slate-500"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-sm text-slate-300">${step.label}</div>
                        <div class="text-xs text-slate-500 mt-1" id="step-detail-${step.stage}"></div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fa-solid fa-circle-notch fa-spin text-slate-500 hidden" id="spinner-${step.stage}"></i>
                        <i class="fa-solid fa-check-circle text-green-400 hidden" id="check-${step.stage}"></i>
                    </div>
                `;
                stepsContainer.appendChild(stepDiv);
            });
        }
        
        function updateProgressStep(stage, message, detail = '') {
            const stepDiv = document.getElementById(`step-${stage}`);
            const spinner = document.getElementById(`spinner-${stage}`);
            const check = document.getElementById(`check-${stage}`);
            const detailDiv = document.getElementById(`step-detail-${stage}`);
            
            if (stepDiv) {
                stepDiv.classList.remove('bg-slate-800/50');
                stepDiv.classList.add('bg-blue-500/10', 'border-blue-500/50');
                
                if (spinner) spinner.classList.remove('hidden');
                if (check) check.classList.add('hidden');
                
                if (detail && detailDiv) {
                    detailDiv.textContent = detail;
                    detailDiv.classList.remove('hidden');
                }
            }
        }
        
        function completeProgressStep(stage, detail = '') {
            const stepDiv = document.getElementById(`step-${stage}`);
            const spinner = document.getElementById(`spinner-${stage}`);
            const check = document.getElementById(`check-${stage}`);
            const detailDiv = document.getElementById(`step-detail-${stage}`);
            
            if (stepDiv) {
                stepDiv.classList.remove('bg-blue-500/10', 'border-blue-500/50');
                stepDiv.classList.add('bg-green-500/10', 'border-green-500/50');
                
                if (spinner) spinner.classList.add('hidden');
                if (check) check.classList.remove('hidden');
                
                if (detail && detailDiv) {
                    detailDiv.textContent = detail;
                }
            }
        }
        
        function closeAnalysisProgress() {
            const modal = document.getElementById('analysisProgressModal');
            if (modal) modal.remove();
        }
        
        // Individual scan removed - calls are auto-processed in parallel on page load

        // Update memories button visibility based on analyzed count
        async function updateMemoriesVisibility() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success && data.stats) {
                    const canShow = data.stats.can_show_memories;
                    // Update all View Memories buttons
                    document.querySelectorAll('[onclick^="showCustomerMemories"]').forEach(btn => {
                        if (canShow) {
                            btn.style.display = 'inline-flex';
                        } else {
                            btn.style.display = 'none';
                        }
                    });
                }
            } catch (e) {
                console.error('Failed to update memories visibility:', e);
            }
        }


        // Initialize popover click handlers
        function initPopovers() {
            document.querySelectorAll('.popover-trigger').forEach(trigger => {
                trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close other popovers
                    document.querySelectorAll('.popover-trigger').forEach(t => {
                        if(t !== trigger) t.classList.remove('active');
                    });
                    // Toggle current popover
                    trigger.classList.toggle('active');
                });
            });

            // Close popovers when clicking outside
            document.addEventListener('click', (e) => {
                if(!e.target.closest('.popover-trigger')) {
                    document.querySelectorAll('.popover-trigger').forEach(t => {
                        t.classList.remove('active');
                    });
                }
            });
        }

        // Global state for memories
        let allMemories = [];
        let currentMemoryTab = 'ALL';
        let currentCustomerFilter = '';
        let currentCallFilter = '';
        
        // Load Master Memory Insights on page load
        async function loadMasterMemoryInsights() {
            try {
                const response = await fetch('/api/master-memory?limit=1000');
                if (!response.ok) return;
                
                const data = await response.json();
                if (!data.success) return;
                
                allMemories = data.memories || [];
                const container = document.getElementById('insightsContainer');
                if (!container) return;
                
                // Build tabs from unique call IDs
                buildMemoryTabs(allMemories);
                
                // Update filters
                updateMemoryFilters(allMemories);
                
                // Display memories based on current tab and filters
                displayMemories();
                
                // Update stats
                updateMasterMemoryStats(allMemories);
            } catch (error) {
                console.error('Failed to load master memory insights:', error);
            }
        }
        
        // Build memory tabs from calls
        function buildMemoryTabs(memories) {
            const tabsContainer = document.getElementById('memoryTabsContainer');
            if (!tabsContainer) return;
            
            // Get unique call IDs
            const callMap = new Map();
            memories.forEach(mem => {
                const callId = mem.metadata?.call_id;
                const company = mem.metadata?.customer_company || 'Unknown';
                if (callId && !callMap.has(callId)) {
                    callMap.set(callId, company);
                }
            });
            
            // Build tabs HTML
            let tabsHTML = `
                <button onclick="switchMemoryTab('ALL')" 
                    id="memoryTab-ALL"
                    class="px-4 py-2 text-sm font-semibold border-b-2 transition-all whitespace-nowrap
                    ${currentMemoryTab === 'ALL' ? 'border-purple-500 text-purple-300' : 'border-transparent text-slate-400 hover:text-slate-300'}">
                    <i class="fa-solid fa-list mr-2"></i>ALL
                </button>
            `;
            
            // Add per-call tabs
            Array.from(callMap.entries()).forEach(([callId, company]) => {
                const tabId = `memoryTab-${callId}`;
                const isActive = currentMemoryTab === callId;
                tabsHTML += `
                    <button onclick="switchMemoryTab('${callId}')" 
                        id="${tabId}"
                        class="px-4 py-2 text-sm font-semibold border-b-2 transition-all whitespace-nowrap
                        ${isActive ? 'border-purple-500 text-purple-300' : 'border-transparent text-slate-400 hover:text-slate-300'}">
                        <i class="fa-solid fa-phone mr-2"></i>${company.substring(0, 20)}${company.length > 20 ? '...' : ''}
                    </button>
                `;
            });
            
            tabsContainer.innerHTML = tabsHTML;
        }
        
        // Update memory filters dropdowns
        function updateMemoryFilters(memories) {
            const customerFilter = document.getElementById('customerFilter');
            const callFilter = document.getElementById('callFilter');
            
            if (!customerFilter || !callFilter) return;
            
            // Get unique customers
            const customers = new Set();
            const calls = new Map();
            memories.forEach(mem => {
                const company = mem.metadata?.customer_company;
                const callId = mem.metadata?.call_id;
                if (company && company !== 'Unknown') customers.add(company);
                if (callId) {
                    if (!calls.has(callId)) {
                        calls.set(callId, company || 'Unknown');
                    }
                }
            });
            
            // Update customer filter
            customerFilter.innerHTML = '<option value="">All Customers</option>';
            Array.from(customers).sort().forEach(customer => {
                customerFilter.innerHTML += `<option value="${customer}">${customer}</option>`;
            });
            
            // Update call filter
            callFilter.innerHTML = '<option value="">All Calls</option>';
            Array.from(calls.entries()).forEach(([callId, company]) => {
                callFilter.innerHTML += `<option value="${callId}">${company} - ${callId.substring(0, 12)}...</option>`;
            });
        }
        
        // Switch memory tab
        function switchMemoryTab(tabId) {
            currentMemoryTab = tabId;
            
            // Update tab styles
            document.querySelectorAll('[id^="memoryTab-"]').forEach(btn => {
                btn.classList.remove('border-purple-500', 'text-purple-300');
                btn.classList.add('border-transparent', 'text-slate-400');
            });
            const activeTab = document.getElementById(`memoryTab-${tabId}`);
            if (activeTab) {
                activeTab.classList.add('border-purple-500', 'text-purple-300');
                activeTab.classList.remove('border-transparent', 'text-slate-400');
            }
            
            // Show/hide filters based on tab
            const filtersDiv = document.getElementById('memoryFilters');
            if (filtersDiv) {
                filtersDiv.style.display = tabId === 'ALL' ? 'flex' : 'none';
            }
            
            // Display memories
            displayMemories();
        }
        
        // Filter memories
        function filterMemories() {
            currentCustomerFilter = document.getElementById('customerFilter')?.value || '';
            currentCallFilter = document.getElementById('callFilter')?.value || '';
            displayMemories();
        }
        
        // Display memories based on current tab and filters
        function displayMemories() {
            const container = document.getElementById('insightsContainer');
            if (!container) return;
            
            // Filter memories
            let filteredMemories = allMemories;
            
            // Filter by tab
            if (currentMemoryTab !== 'ALL') {
                filteredMemories = filteredMemories.filter(mem => 
                    mem.metadata?.call_id === currentMemoryTab
                );
            }
            
            // Apply filters (only for ALL tab)
            if (currentMemoryTab === 'ALL') {
                if (currentCustomerFilter) {
                    filteredMemories = filteredMemories.filter(mem => 
                        mem.metadata?.customer_company === currentCustomerFilter
                    );
                }
                if (currentCallFilter) {
                    filteredMemories = filteredMemories.filter(mem => 
                        mem.metadata?.call_id === currentCallFilter
                    );
                }
            }
            
            // Display empty state
            if (filteredMemories.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-16 text-slate-400">
                        <div class="inline-block mb-4">
                            <div class="w-20 h-20 rounded-2xl bg-purple-500/10 border border-purple-500/30 flex items-center justify-center">
                                <i class="fa-solid fa-brain text-4xl text-purple-400/50"></i>
                            </div>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-300 mb-2">No insights found</h4>
                        <p class="text-sm max-w-md mx-auto">${currentMemoryTab === 'ALL' ? 'Try adjusting your filters or check other tabs.' : 'No memories for this call yet.'}</p>
                    </div>
                `;
                return;
            }
            
            // Display memories
            container.innerHTML = filteredMemories.map((mem, idx) => {
                let memoryText = mem.memory || mem.text || JSON.stringify(mem);
                const metadata = mem.metadata || {};
                const company = metadata.customer_company || 'Unknown';
                const callId = metadata.call_id || '';
                const isLong = memoryText.length > 200;
                const displayText = memoryText.substring(0, 200);
                
                return `
                    <div class="group relative glass-enhanced border border-slate-800/50 rounded-xl p-5 hover:border-purple-500/50 transition-all hover:shadow-lg hover:shadow-purple-500/10 bg-gradient-to-br from-slate-800/30 to-slate-900/30 backdrop-blur-sm">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500/30 to-indigo-500/30 border border-purple-500/50 flex items-center justify-center text-sm font-bold text-purple-200 shadow-lg shadow-purple-500/20 group-hover:scale-110 transition-transform">
                                ${idx + 1}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-slate-200 leading-relaxed mb-3 font-medium">${displayText}${isLong ? '...' : ''}</p>
                                <div class="flex items-center gap-4 text-xs">
                                    ${company && company !== 'Unknown' ? `
                                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-blue-500/10 border border-blue-500/30 text-blue-300">
                                            <i class="fa-solid fa-building text-[10px]"></i>
                                            <span class="font-semibold">${company}</span>
                                        </span>
                                    ` : ''}
                                    ${callId ? `
                                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-slate-700/50 border border-slate-600/50 text-slate-400">
                                            <i class="fa-solid fa-phone text-[10px]"></i>
                                            <span class="font-mono text-[10px]">${callId.substring(0, 16)}...</span>
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="w-2 h-2 rounded-full bg-purple-400 animate-pulse"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update Master Memory Stats
        async function updateMasterMemoryStats(memories) {
            try {
                const totalInsights = document.getElementById('totalInsights');
                const callsAnalyzed = document.getElementById('callsAnalyzed');
                const customersCount = document.getElementById('customersCount');
                
                // Count unique call IDs from memories
                const uniqueCalls = new Set();
                const uniqueCustomers = new Set();
                
                memories.forEach(mem => {
                    const callId = mem.metadata?.call_id;
                    const company = mem.metadata?.customer_company;
                    
                    if (callId) {
                        uniqueCalls.add(callId);
                    }
                    if (company && company !== 'Unknown') {
                        uniqueCustomers.add(company);
                    }
                });
                
                // Get total insights count from master memory API (for accurate count)
                try {
                    const masterMemoryResponse = await fetch('/api/master-memory?limit=1000');
                    if (masterMemoryResponse.ok) {
                        const masterData = await masterMemoryResponse.json();
                        if (masterData.success && masterData.memories) {
                            if (totalInsights) totalInsights.textContent = masterData.memories.length;
                        } else {
                            if (totalInsights) totalInsights.textContent = memories.length;
                        }
                    } else {
                        if (totalInsights) totalInsights.textContent = memories.length;
                    }
                } catch (e) {
                    if (totalInsights) totalInsights.textContent = memories.length;
                }
                
                // Update calls analyzed count from unique call IDs
                if (callsAnalyzed) callsAnalyzed.textContent = uniqueCalls.size;
                
                // Update customers count
                if (customersCount) customersCount.textContent = uniqueCustomers.size;
                
            } catch (error) {
                console.error('Failed to update stats:', error);
                // Fallback: use memories data
                const totalInsights = document.getElementById('totalInsights');
                const callsAnalyzed = document.getElementById('callsAnalyzed');
                const customersCount = document.getElementById('customersCount');
                
                if (totalInsights) totalInsights.textContent = memories.length;
                
                const uniqueCalls = new Set();
                const uniqueCustomers = new Set();
                memories.forEach(mem => {
                    const callId = mem.metadata?.call_id;
                    const company = mem.metadata?.customer_company;
                    if (callId) uniqueCalls.add(callId);
                    if (company && company !== 'Unknown') uniqueCustomers.add(company);
                });
                
                if (callsAnalyzed) callsAnalyzed.textContent = uniqueCalls.size;
                if (customersCount) customersCount.textContent = uniqueCustomers.size;
            }
        }
        
        // Load Master Memory Patterns
        async function loadMasterMemoryPatterns() {
            try {
                const response = await fetch('/api/master-memory/patterns');
                if (!response.ok) {
                    showNotification('Failed to load patterns', 'error');
                    return;
                }
                
                const data = await response.json();
                if (!data.success) {
                    showNotification(data.error || 'Failed to load patterns', 'error');
                    return;
                }
                
                const patterns = data.patterns || [];
                showMasterMemory(); // Show in modal
                // Could enhance to show patterns in a dedicated view
            } catch (error) {
                console.error('Failed to load patterns:', error);
                showNotification('Failed to load patterns', 'error');
            }
        }
        
        // WebSocket removed - not essential for this example
        // Users can manually refresh memories using the refresh button
        // This simplifies the codebase and removes connection errors
        
        // Initialize on DOM ready
        if(document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initElements();
                initTabElements();
                loadWatchlist();
                initPopovers();
                updateMemoriesVisibility();
                loadMasterMemoryInsights(); // Load master memory on page load
            });
        } else {
            initElements();
            initTabElements();
            loadWatchlist();
            initPopovers();
            updateMemoriesVisibility();
            loadMasterMemoryInsights(); // Load master memory on page load
        }

        // Close modal on outside click
        document.addEventListener('click', (e) => {
            if(elements.settingsModal && e.target === elements.settingsModal) {
                closeSettings();
            }
        });

        function updateSort() {
            const sortValue = document.getElementById('sortSelector').value;

            // Update URL and reload
            const url = new URL(window.location);
            url.searchParams.set('sort_by', sortValue);
            // Preserve keyword filter if present
            const keyword = url.searchParams.get('keyword');
            if(keyword) {
                url.searchParams.set('keyword', keyword);
            }
            window.location.href = url.toString();
        }

        function filterByKeyword(keyword) {
            // Update URL and reload
            const url = new URL(window.location);
            if(keyword) {
                url.searchParams.set('keyword', keyword);
            } else {
                url.searchParams.delete('keyword');
            }
            // Preserve sort_by if present
            const sortBy = url.searchParams.get('sort_by');
            if(sortBy) {
                url.searchParams.set('sort_by', sortBy);
            }
            window.location.href = url.toString();
        }

        // Load reports dynamically when sort changes (for future AJAX implementation)
        // loadReports function removed - focusing on calls only
        async function loadReports_DISABLED(sortBy = 'date_desc') {
            try {
                const url = new URL('/api/reports', window.location.origin);
                url.searchParams.set('limit', '10');
                url.searchParams.set('sort_by', sortBy);
                const keyword = new URL(window.location).searchParams.get('keyword');
                if(keyword) {
                    url.searchParams.set('keyword', keyword);
                }
                const res = await fetch(url);
                const data = await res.json();
                if(data.success) {
                    // Could update DOM here instead of reloading
                    // For now, we'll use URL-based filtering
                    return data.reports;
                }
            } catch(e) {
                console.error('Failed to load reports:', e);
            }
            return [];
        }

        // --- PARALLAX EFFECTS ---

        // 1. Subtle Background Parallax (throttled for performance)
        let mouseX = 0.5;
        let mouseY = 0.5;
        let rafId = null;

        function updateMouseParallax() {
            document.documentElement.style.setProperty('--mouse-x', mouseX);
            document.documentElement.style.setProperty('--mouse-y', mouseY);
            rafId = null;
        }

        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX / window.innerWidth;
            mouseY = e.clientY / window.innerHeight;
            if(!rafId) {
                rafId = requestAnimationFrame(updateMouseParallax);
            }
        }, { passive: true });

        // 2. Scroll Parallax (throttled)
        let scrollY = 0;
        let scrollRafId = null;

        function updateScrollParallax() {
            document.documentElement.style.setProperty('--scroll-y', scrollY);
            scrollRafId = null;
        }

        window.addEventListener('scroll', () => {
            scrollY = window.scrollY;
            if(!scrollRafId) {
                scrollRafId = requestAnimationFrame(updateScrollParallax);
            }
        }, { passive: true });

        // 3. Intersection Observer for Card Reveals
        const cardObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    cardObserver.unobserve(entry.target); // Stop observing once revealed
                }
            });
        }, {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        });

        // Observe cards after DOM ready
        if(document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCardObserver);
        } else {
            initCardObserver();
        }

        function initCardObserver() {
            document.querySelectorAll('.parallax-card').forEach(card => {
                cardObserver.observe(card);
            });
        }

        // Snippet functionality removed - using memory only, no RAG

        // Customer Memories Modal - PER-CALL memories
        async function showCustomerMemories(company, callId) {
            try {
                // ALWAYS use per-call endpoint - memories are stored per-call
                let response;
                let isPerCall = true;
                
                if (callId && callId !== 'unknown' && callId !== '') {
                    // Per-call memories
                    response = await fetch(`/api/reports/${encodeURIComponent(callId)}/memories?limit=20`);
                    isPerCall = true;
                } else {
                    // Fallback: try to aggregate by company (but memories are per-call)
                    response = await fetch(`/api/customers/${encodeURIComponent(company)}/memories?limit=20`);
                    isPerCall = false;
                }
                
                if (!response.ok) {
                    showNotification('Failed to load memories', 'error');
                    return;
                }
                
                const data = await response.json();
                if (!data.success) {
                    showNotification(data.error || 'Failed to load memories', 'error');
                    return;
                }
                
                const memories = data.memories || [];
                
                if (memories.length === 0) {
                    const message = isPerCall 
                        ? 'No memories extracted from this call yet. Memories are automatically extracted when calls are analyzed.'
                        : 'No memories found for this customer yet';
                    showNotification(message, 'info');
                    return;
                }
                
                // Organize memories by category
                const organized = {
                    preferences: [],
                    pain_points: [],
                    deals: [],
                    products: [],
                    other: []
                };
                
                memories.forEach(mem => {
                    // Handle different memory formats from mem0
                    let memoryText = '';
                    if (mem.memory) {
                        memoryText = typeof mem.memory === 'string' ? mem.memory : JSON.stringify(mem.memory);
                    } else if (mem.memories && Array.isArray(mem.memories) && mem.memories.length > 0) {
                        memoryText = mem.memories[0].memory || JSON.stringify(mem.memories[0]);
                    } else if (mem.data && mem.data.memory) {
                        memoryText = typeof mem.data.memory === 'string' ? mem.data.memory : JSON.stringify(mem.data.memory);
                    } else if (mem.content) {
                        memoryText = typeof mem.content === 'string' ? mem.content : JSON.stringify(mem.content);
                    } else {
                        memoryText = JSON.stringify(mem);
                    }
                    const lowerText = memoryText.toLowerCase();
                    
                    if (lowerText.includes('prefer') || lowerText.includes('like') || lowerText.includes('interest')) {
                        organized.preferences.push(mem);
                    } else if (lowerText.includes('pain') || lowerText.includes('problem') || lowerText.includes('challenge') || lowerText.includes('issue')) {
                        organized.pain_points.push(mem);
                    } else if (lowerText.includes('deal') || lowerText.includes('pricing') || lowerText.includes('purchase') || lowerText.includes('buy')) {
                        organized.deals.push(mem);
                    } else if (lowerText.includes('product') || lowerText.includes('feature') || lowerText.includes('integration')) {
                        organized.products.push(mem);
                    } else {
                        organized.other.push(mem);
                    }
                });
                
                let memoriesHTML = '';
                
                const categories = [
                    { key: 'preferences', title: 'Customer Preferences', icon: 'fa-heart', color: 'pink' },
                    { key: 'pain_points', title: 'Pain Points', icon: 'fa-exclamation-triangle', color: 'red' },
                    { key: 'deals', title: 'Deal History', icon: 'fa-dollar-sign', color: 'green' },
                    { key: 'products', title: 'Product Interests', icon: 'fa-box', color: 'blue' },
                    { key: 'other', title: 'Other Insights', icon: 'fa-lightbulb', color: 'yellow' }
                ];
                
                categories.forEach(cat => {
                    const items = organized[cat.key];
                    if (items.length > 0) {
                        memoriesHTML += `
                            <div class="mb-6">
                                <div class="flex items-center gap-2 mb-3">
                                    <div class="flex items-center gap-1.5 text-${cat.color}-300">
                                        <i class="fa-solid ${cat.icon} text-sm"></i>
                                        <h3 class="text-sm font-bold uppercase tracking-wider">${cat.title}</h3>
                                        <span class="text-xs text-slate-400">(${items.length})</span>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${items.slice(0, 5).map((mem, idx) => {
                                        // Handle different memory formats
                                        let memoryText = '';
                                        if (mem.memory) {
                                            memoryText = typeof mem.memory === 'string' ? mem.memory : JSON.stringify(mem.memory);
                                        } else if (mem.memories && Array.isArray(mem.memories) && mem.memories.length > 0) {
                                            memoryText = mem.memories[0].memory || JSON.stringify(mem.memories[0]);
                                        } else if (mem.data && mem.data.memory) {
                                            memoryText = typeof mem.data.memory === 'string' ? mem.data.memory : JSON.stringify(mem.data.memory);
                                        } else if (mem.content) {
                                            memoryText = typeof mem.content === 'string' ? mem.content : JSON.stringify(mem.content);
                                        } else {
                                            memoryText = JSON.stringify(mem);
                                        }
                                        const metadata = mem.metadata || {};
                                        const callId = metadata.call_id || '';
                                        const timestamp = metadata.timestamp || mem.created_at || mem.timestamp || '';
                                        return `
                                            <div class="bg-slate-800/50 border border-slate-700/50 rounded-lg p-4 hover:border-${cat.color}-500/40 transition-all">
                                                <div class="flex items-start gap-3">
                                                    <div class="flex-shrink-0 w-6 h-6 rounded-full bg-${cat.color}-500/20 border border-${cat.color}-500/40 flex items-center justify-center text-xs font-bold text-${cat.color}-300">
                                                        ${idx + 1}
                                                    </div>
                                                    <div class="flex-1">
                                                        <p class="text-xs text-slate-300 leading-relaxed mb-2">${memoryText.substring(0, 300)}${memoryText.length > 300 ? '...' : ''}</p>
                                                        ${callId ? `<p class="text-[10px] text-slate-500">From call: ${callId.substring(0, 8)}...</p>` : ''}
                                                        ${timestamp ? `<p class="text-[10px] text-slate-500">${timestamp.substring(0, 10)}</p>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
                
                const modal = document.createElement('div');
                modal.id = 'memoriesModal';
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm';
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.2s';
                modal.innerHTML = `
                    <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="flex items-center justify-between p-6 border-b border-slate-700 bg-gradient-to-r from-slate-800/50 to-slate-900/50">
                            <div>
                                <h2 class="text-xl font-bold text-white mb-1">Call Memories</h2>
                                <p class="text-sm text-slate-400">${callId && callId !== 'unknown' ? `Call ${callId.substring(0, 12)}...` : company} - ${memories.length} memories (per-call)</p>
                            </div>
                            <button onclick="closeMemoriesModal()" class="text-slate-400 hover:text-white transition-all hover:scale-110 rounded p-2 hover:bg-slate-800">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6">
                            <div class="mb-4 p-4 bg-gradient-to-r from-blue-900/30 to-indigo-900/30 border border-blue-500/40 rounded-lg">
                                <div class="flex items-start gap-3">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500/20 border border-blue-500/40 flex items-center justify-center">
                                        <i class="fa-solid fa-brain text-blue-300 text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-sm font-bold text-blue-200 mb-1">Powered by mdb-engine Memory Component (Mem0)</h3>
                                        <p class="text-xs text-blue-100/90 leading-relaxed mb-2">
                                            <strong>Per-call memories</strong> are automatically extracted from call transcripts using <strong>Mem0.ai</strong> and stored in MongoDB. Each call has its own memory store. <strong>No RAG/vector search</strong> - pure memory-based intelligence.
                                        </p>
                                        <div class="text-[10px] text-blue-200/70 space-y-1 mt-2">
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-circle text-[4px]"></i>
                                                <span>Memories stored per-call (user_id: call_{call_id})</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-circle text-[4px]"></i>
                                                <span>LLM inference extracts key insights automatically</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-circle text-[4px]"></i>
                                                <span>Memory-only approach - no vector search/RAG</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ${memoriesHTML || '<p class="text-slate-400 text-sm">No memories found.</p>'}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                setTimeout(() => { modal.style.opacity = '1'; }, 10);
                modal.addEventListener('click', (e) => { if (e.target === modal) closeMemoriesModal(); });
                
            } catch (error) {
                console.error('Error loading memories:', error);
                showNotification('Failed to load customer memories', 'error');
            }
        }
        
        function closeMemoriesModal() {
            const modal = document.getElementById('memoriesModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 200);
            }
        }
        
        // Master Memory Modal - Global cross-call intelligence
        async function showMasterMemory() {
            try {
                const response = await fetch('/api/master-memory?limit=30');
                if (!response.ok) {
                    showNotification('Failed to load master memory', 'error');
                    return;
                }
                
                const data = await response.json();
                if (!data.success) {
                    showNotification(data.error || 'Failed to load master memory', 'error');
                    return;
                }
                
                const memories = data.memories || [];
                
                let memoriesHTML = '';
                if (memories.length > 0) {
                    memories.forEach((mem, idx) => {
                        let memoryText = mem.memory || mem.text || JSON.stringify(mem);
                        const metadata = mem.metadata || {};
                        const callId = metadata.call_id || '';
                        const company = metadata.customer_company || '';
                        
                        memoriesHTML += `
                            <div class="bg-slate-800/50 border border-slate-700/50 rounded-lg p-4 hover:border-purple-500/40 transition-all mb-3">
                                <div class="flex items-start gap-3">
                                    <div class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500/20 border border-purple-500/40 flex items-center justify-center text-xs font-bold text-purple-300">
                                        ${idx + 1}
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-xs text-slate-300 leading-relaxed mb-2">${memoryText.substring(0, 400)}${memoryText.length > 400 ? '...' : ''}</p>
                                        ${company ? `<p class="text-[10px] text-slate-500">Company: ${company}</p>` : ''}
                                        ${callId ? `<p class="text-[10px] text-slate-500">Call: ${callId.substring(0, 8)}...</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    memoriesHTML = '<p class="text-slate-400 text-sm">No master memory entries yet. Master memory will populate as calls are analyzed.</p>';
                }
                
                const modal = document.createElement('div');
                modal.id = 'masterMemoryModal';
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm';
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.2s';
                modal.innerHTML = `
                    <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="flex items-center justify-between p-6 border-b border-slate-700 bg-gradient-to-r from-purple-800/50 to-indigo-900/50">
                            <div>
                                <h2 class="text-xl font-bold text-white mb-1">Master Memory</h2>
                                <p class="text-sm text-slate-400">Global cross-call intelligence - ${memories.length} insights across all customers</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="showMasterMemoryChat()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all text-sm">
                                    <i class="fa-solid fa-comments mr-2"></i>Chat
                                </button>
                                <button onclick="closeMasterMemoryModal()" class="text-slate-400 hover:text-white transition-all hover:scale-110 rounded p-2 hover:bg-slate-800">
                                    <i class="fa-solid fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6">
                            <div class="mb-4 p-4 bg-gradient-to-r from-purple-900/30 to-indigo-900/30 border border-purple-500/40 rounded-lg">
                                <div class="flex items-start gap-3">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-500/20 border border-purple-500/40 flex items-center justify-center">
                                        <i class="fa-solid fa-brain text-purple-300 text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-sm font-bold text-purple-200 mb-1">Global Cross-Call Intelligence</h3>
                                        <p class="text-xs text-purple-100/90 leading-relaxed mb-2">
                                            Master memory aggregates insights from <strong>all calls across all customers</strong> using Mem0. This enables pattern detection, trend analysis, and cross-customer intelligence. <strong>No RAG/vector search</strong> - pure memory-based intelligence.
                                        </p>
                                        <div class="text-[10px] text-purple-200/70 space-y-1 mt-2">
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-circle text-[4px]"></i>
                                                <span>Aggregates insights from all analyzed calls using Mem0</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-circle text-[4px]"></i>
                                                <span>Enables cross-customer pattern detection</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid fa-circle text-[4px]"></i>
                                                <span>Chat with master memory for insights (memory-only, no RAG)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ${memoriesHTML}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                setTimeout(() => { modal.style.opacity = '1'; }, 10);
                modal.addEventListener('click', (e) => { if (e.target === modal) closeMasterMemoryModal(); });
                
            } catch (error) {
                console.error('Error loading master memory:', error);
                showNotification('Failed to load master memory', 'error');
            }
        }
        
        function closeMasterMemoryModal() {
            const modal = document.getElementById('masterMemoryModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 200);
            }
        }
        
        // Master Memory Chat Modal
        async function showMasterMemoryChat() {
            closeMasterMemoryModal();
            
            const modal = document.createElement('div');
            modal.id = 'masterMemoryChatModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm';
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.2s';
            
            let chatHistory = [];
            
            const sendMessage = async () => {
                const input = document.getElementById('masterChatInput');
                const message = input.value.trim();
                if (!message) return;
                
                // Add user message to chat
                chatHistory.push({ role: 'user', content: message });
                updateChatDisplay();
                input.value = '';
                
                // Show loading
                const loadingId = 'loading-' + Date.now();
                chatHistory.push({ role: 'assistant', content: '...', loading: true, id: loadingId });
                updateChatDisplay();
                
                try {
                    const response = await fetch('/api/master-memory/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        // Remove loading message
                        chatHistory = chatHistory.filter(m => m.id !== loadingId);
                        chatHistory.push({ 
                            role: 'assistant', 
                            content: data.response,
                            memory_context: data.memory_context
                        });
                    } else {
                        chatHistory = chatHistory.filter(m => m.id !== loadingId);
                        chatHistory.push({ role: 'assistant', content: 'Error: ' + (data.error || 'Failed to get response') });
                    }
                } catch (error) {
                    chatHistory = chatHistory.filter(m => m.id !== loadingId);
                    chatHistory.push({ role: 'assistant', content: 'Error: ' + error.message });
                }
                
                updateChatDisplay();
            };
            
            const updateChatDisplay = () => {
                const chatContainer = document.getElementById('masterChatMessages');
                chatContainer.innerHTML = chatHistory.map(msg => {
                    if (msg.loading) {
                        return `<div class="flex items-start gap-3 mb-4"><div class="bg-slate-800 rounded-lg p-3"><div class="flex gap-1"><div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div><div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div></div></div></div>`;
                    }
                    const isUser = msg.role === 'user';
                    return `
                        <div class="flex items-start gap-3 mb-4 ${isUser ? 'flex-row-reverse' : ''}">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full ${isUser ? 'bg-blue-600' : 'bg-purple-600'} flex items-center justify-center">
                                <i class="fa-solid ${isUser ? 'fa-user' : 'fa-brain'} text-white text-xs"></i>
                            </div>
                            <div class="flex-1 ${isUser ? 'text-right' : ''}">
                                <div class="inline-block ${isUser ? 'bg-blue-600' : 'bg-slate-800'} rounded-lg p-3 max-w-[80%]">
                                    <p class="text-sm text-white">${msg.content}</p>
                                </div>
                                ${msg.memory_context && msg.memory_context.used_memories > 0 ? `
                                    <p class="text-xs text-slate-400 mt-1">Used ${msg.memory_context.used_memories} memories from master memory</p>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            };
            
            modal.innerHTML = `
                <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="flex items-center justify-between p-6 border-b border-slate-700 bg-gradient-to-r from-purple-800/50 to-indigo-900/50">
                        <div>
                            <h2 class="text-xl font-bold text-white mb-1">Chat with Master Memory</h2>
                            <p class="text-sm text-slate-400">Ask questions about cross-call patterns and insights (memory-only, no RAG)</p>
                        </div>
                        <button onclick="closeMasterMemoryChatModal()" class="text-slate-400 hover:text-white transition-all hover:scale-110 rounded p-2 hover:bg-slate-800">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="masterChatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                        <div class="text-center text-slate-400 text-sm">
                            <i class="fa-solid fa-comments text-2xl mb-2 block"></i>
                            <p>Start a conversation with master memory</p>
                            <p class="text-xs mt-2">Ask about patterns, trends, or insights across all calls</p>
                            <p class="text-[10px] mt-1 text-purple-300/70">Powered by Mem0 - memory-only intelligence, no RAG/vector search</p>
                        </div>
                    </div>
                    <div class="p-4 border-t border-slate-700">
                        <div class="flex gap-2">
                            <input id="masterChatInput" type="text" placeholder="Ask about cross-call patterns..." 
                                class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:border-purple-500"
                                onkeypress="if(event.key==='Enter') { window.sendMasterChatMessage(); }">
                            <button id="masterChatSendBtn" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            setTimeout(() => { modal.style.opacity = '1'; }, 10);
            
            // Attach sendMessage to window scope and button
            window.sendMasterChatMessage = sendMessage;
            const sendBtn = document.getElementById('masterChatSendBtn');
            sendBtn.onclick = sendMessage;
            
            // Focus input
            setTimeout(() => document.getElementById('masterChatInput').focus(), 100);
        }
        
        function closeMasterMemoryChatModal() {
            const modal = document.getElementById('masterMemoryChatModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 200);
            }
        }

        // Longitudinal Intelligence Modal
        async function showLongitudinalIntelligence(company) {
            try {
                const response = await fetch(`/api/customers/${encodeURIComponent(company)}/intelligence`);
                if (!response.ok) {
                    showNotification('Failed to load longitudinal intelligence', 'error');
                    return;
                }
                
                const data = await response.json();
                if (!data.success || !data.intelligence) {
                    showNotification(data.error || 'No intelligence data available yet', 'info');
                    return;
                }
                
                const intelligence = data.intelligence;
                const profile = intelligence.profile || {};
                const patterns = intelligence.recent_patterns || [];
                const contradictions = intelligence.active_contradictions || [];
                const continuity = intelligence.continuity_summary || {};
                
                let intelligenceHTML = '';
                
                // Relationship Health Score
                const healthScore = profile.relationship_health_score || 0;
                const healthColor = healthScore >= 80 ? 'green' : healthScore >= 60 ? 'yellow' : 'red';
                intelligenceHTML += `
                    <div class="mb-6 p-4 bg-gradient-to-r from-${healthColor}-900/30 to-${healthColor}-800/20 border border-${healthColor}-500/40 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-${healthColor}-500/20 border border-${healthColor}-500/40 flex items-center justify-center">
                                    <span class="text-xl font-bold text-${healthColor}-300">${healthScore}</span>
                                </div>
                                <div>
                                    <h3 class="text-sm font-bold text-${healthColor}-200">Relationship Health Score</h3>
                                    <p class="text-xs text-slate-400">Based on sentiment velocity, risk indicators, and engagement trends</p>
                                </div>
                            </div>
                        </div>
                        <div class="w-full bg-slate-800/50 rounded-full h-2 mb-2">
                            <div class="bg-${healthColor}-500 h-2 rounded-full transition-all duration-500" style="width: ${healthScore}%"></div>
                        </div>
                        <div class="text-xs text-slate-400">
                            ${profile.total_calls || 0} total calls analyzed | Last updated: ${profile.last_call_timestamp ? profile.last_call_timestamp.substring(0, 10) : 'N/A'}
                        </div>
                    </div>
                `;
                
                // Sentiment Velocity (Patterns)
                if (patterns.length > 0) {
                    const latestPatterns = patterns[0].patterns || {};
                    const sentimentVelocity = latestPatterns.sentiment_velocity || {};
                    if (sentimentVelocity.trend) {
                        const trendColor = sentimentVelocity.trend === 'improving' ? 'green' : sentimentVelocity.trend === 'declining' ? 'red' : 'yellow';
                        intelligenceHTML += `
                            <div class="mb-6">
                                <div class="flex items-center gap-2 mb-3">
                                    <i class="fa-solid fa-chart-line text-purple-400"></i>
                                    <h3 class="text-sm font-bold text-purple-300 uppercase tracking-wider">Sentiment Velocity</h3>
                                </div>
                                <div class="p-4 bg-slate-800/50 border border-purple-500/30 rounded-lg">
                                    <div class="flex items-center gap-4 mb-2">
                                        <span class="text-xs font-semibold text-${trendColor}-300">${sentimentVelocity.trend.toUpperCase()}</span>
                                        <span class="text-xs text-slate-400">Velocity: ${(sentimentVelocity.velocity * 100).toFixed(1)}%</span>
                                    </div>
                                    <p class="text-xs text-slate-300 mb-2">
                                        ${sentimentVelocity.first_half_avg ? `First half avg: ${(sentimentVelocity.first_half_avg * 100).toFixed(1)}%` : ''}
                                        ${sentimentVelocity.second_half_avg ? `  Second half avg: ${(sentimentVelocity.second_half_avg * 100).toFixed(1)}%` : ''}
                                    </p>
                                    ${sentimentVelocity.risk_level === 'high' ? `
                                        <div class="mt-2 p-2 bg-red-500/20 border border-red-500/40 rounded text-xs text-red-300">
                                            <i class="fa-solid fa-exclamation-triangle mr-1"></i>High risk: Silent churn risk detected
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Risk Indicators
                    const riskIndicators = latestPatterns.risk_indicators || [];
                    if (riskIndicators.length > 0) {
                        intelligenceHTML += `
                            <div class="mb-6">
                                <div class="flex items-center gap-2 mb-3">
                                    <i class="fa-solid fa-triangle-exclamation text-red-400"></i>
                                    <h3 class="text-sm font-bold text-red-300 uppercase tracking-wider">Risk Indicators</h3>
                                </div>
                                <div class="space-y-2">
                                    ${riskIndicators.map(risk => `
                                        <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                                            <div class="flex items-start gap-2">
                                                <i class="fa-solid fa-circle-exclamation text-red-400 mt-0.5"></i>
                                                <div class="flex-1">
                                                    <p class="text-xs font-semibold text-red-300 mb-1">${risk.type || 'Risk'}</p>
                                                    <p class="text-xs text-slate-300 mb-2">${risk.description || ''}</p>
                                                    ${risk.recommendation ? `<p class="text-xs text-slate-400 italic"> ${risk.recommendation}</p>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Contradictions
                if (contradictions.length > 0) {
                    intelligenceHTML += `
                        <div class="mb-6">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid fa-circle-exclamation text-yellow-400"></i>
                                <h3 class="text-sm font-bold text-yellow-300 uppercase tracking-wider">Detected Contradictions</h3>
                            </div>
                            <div class="space-y-2">
                                ${contradictions.map(cont => {
                                    const isUpsell = cont.opportunity === 'upsell';
                                    const bgColor = isUpsell ? 'green' : 'yellow';
                                    return `
                                        <div class="p-3 bg-${bgColor}-500/10 border border-${bgColor}-500/30 rounded-lg">
                                            <div class="flex items-start gap-2">
                                                <i class="fa-solid ${isUpsell ? 'fa-arrow-trend-up' : 'fa-exclamation'} text-${bgColor}-400 mt-0.5"></i>
                                                <div class="flex-1">
                                                    <p class="text-xs font-semibold text-${bgColor}-300 mb-1">${cont.type || 'Contradiction'}</p>
                                                    <p class="text-xs text-slate-300 mb-1">${cont.description || ''}</p>
                                                    ${cont.old_value && cont.new_value ? `
                                                        <p class="text-xs text-slate-400">Changed from: <span class="font-mono">${cont.old_value}</span>  <span class="font-mono">${cont.new_value}</span></p>
                                                    ` : ''}
                                                    ${isUpsell ? `
                                                        <div class="mt-2 p-2 bg-green-500/20 border border-green-500/40 rounded text-xs text-green-300">
                                                            <i class="fa-solid fa-lightbulb mr-1"></i>Upsell Opportunity Detected!
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Continuity Summary
                if (continuity.recent_history) {
                    intelligenceHTML += `
                        <div class="mb-6">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid fa-book-open text-cyan-400"></i>
                                <h3 class="text-sm font-bold text-cyan-300 uppercase tracking-wider">State of the Union</h3>
                            </div>
                            <div class="p-4 bg-slate-800/50 border border-cyan-500/30 rounded-lg">
                                <p class="text-xs text-slate-300 leading-relaxed whitespace-pre-wrap">${continuity.recent_history}</p>
                            </div>
                        </div>
                    `;
                }
                
                // Talking Points
                if (continuity.talking_points && continuity.talking_points.length > 0) {
                    intelligenceHTML += `
                        <div class="mb-6">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid fa-comments text-blue-400"></i>
                                <h3 class="text-sm font-bold text-blue-300 uppercase tracking-wider">Recommended Talking Points</h3>
                            </div>
                            <div class="space-y-2">
                                ${continuity.talking_points.map(point => `
                                    <div class="p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                        <p class="text-xs text-slate-300">${point}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (!intelligenceHTML) {
                    intelligenceHTML = `
                        <div class="text-center py-12">
                            <i class="fa-solid fa-sparkles text-4xl text-purple-400 mb-4"></i>
                            <p class="text-sm text-slate-400 mb-2">Longitudinal AI Intelligence</p>
                            <p class="text-xs text-slate-500">Need at least 2 calls to generate cross-call intelligence. Keep analyzing calls to unlock pattern recognition, sentiment velocity tracking, and relationship health scoring.</p>
                        </div>
                    `;
                }
                
                const modal = document.createElement('div');
                modal.id = 'intelligenceModal';
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm';
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.2s';
                modal.innerHTML = `
                    <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="flex items-center justify-between p-6 border-b border-slate-700 bg-gradient-to-r from-purple-900/30 to-pink-900/30">
                            <div>
                                <h2 class="text-xl font-bold text-white mb-1">
                                    <i class="fa-solid fa-sparkles text-purple-400 mr-2"></i>Longitudinal AI Intelligence
                                </h2>
                                <p class="text-sm text-slate-400">${company} - Cross-Call Intelligence & Relationship Insights</p>
                            </div>
                            <button onclick="closeIntelligenceModal()" class="text-slate-400 hover:text-white transition-all hover:scale-110 rounded p-2 hover:bg-slate-800">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6">
                            ${intelligenceHTML}
                        </div>
                        <div class="p-4 border-t border-slate-700 bg-slate-800/50">
                            <div class="text-xs text-slate-400 text-center">
                                <i class="fa-solid fa-info-circle mr-1"></i>
                                Powered by the Intelligence Orchestrator - Pattern recognition, sentiment velocity, contradiction detection, and relationship health scoring
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                setTimeout(() => { modal.style.opacity = '1'; }, 10);
                modal.addEventListener('click', (e) => { if (e.target === modal) closeIntelligenceModal(); });
                
            } catch (error) {
                console.error('Error loading longitudinal intelligence:', error);
                showNotification('Failed to load longitudinal intelligence', 'error');
            }
        }
        
        function closeIntelligenceModal() {
            const modal = document.getElementById('intelligenceModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 200);
            }
        }

        // Toggle info banner
        function toggleInfoBanner() {
            const content = document.getElementById('infoBannerContent');
            const toggle = document.getElementById('infoBannerToggle');
            if (content && toggle) {
                const isHidden = content.classList.contains('hidden');
                if (isHidden) {
                    content.classList.remove('hidden');
                    toggle.classList.remove('fa-chevron-down');
                    toggle.classList.add('fa-chevron-up');
                } else {
                    content.classList.add('hidden');
                    toggle.classList.remove('fa-chevron-up');
                    toggle.classList.add('fa-chevron-down');
                }
            }
        }
    </script>
</body>
</html>
