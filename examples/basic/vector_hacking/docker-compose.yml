# ============================================================================
# Vector Hacking - Full Stack
# ============================================================================
#
# Usage:
#   docker-compose up                    # Start everything
#   docker-compose up api mongodb        # API only (no UI)
#   docker-compose --profile db-ui up    # Include MongoDB web UI
#
# Access:
#   - UI:          http://localhost:3000
#   - API:         http://localhost:8000
#   - Swagger:     http://localhost:8000/docs
#   - MongoDB UI:  http://localhost:8081 (with --profile db-ui)
#
# ============================================================================

services:
  # ==========================================================================
  # API (FastAPI Backend)
  # ==========================================================================
  api:
    build:
      context: ../../../
      dockerfile: examples/basic/vector_hacking/api/Dockerfile
    container_name: vector_hacking_api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      - MONGO_URI=mongodb://admin:password@mongodb:27017/?authSource=admin&directConnection=true
      - MONGO_DB_NAME=${MONGO_DB_NAME:-vector_hacking_db}
      - APP_SLUG=vector_hacking_api
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1
      # Azure OpenAI (required)
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION:-2024-02-01}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME:-gpt-4o}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - vector_hacking
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # UI (Static Frontend)
  # ==========================================================================
  ui:
    build:
      context: ./ui
    container_name: vector_hacking_ui
    restart: unless-stopped
    ports:
      - "${UI_PORT:-3000}:80"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - vector_hacking
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # MongoDB Atlas Local (with Vector Search support)
  # ==========================================================================
  mongodb:
    image: mongodb/mongodb-atlas-local:latest
    container_name: vector_hacking_mongodb
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      MONGODB_INITDB_ROOT_USERNAME: admin
      MONGODB_INITDB_ROOT_PASSWORD: password
      MONGODB_INITDB_DATABASE: vector_hacking_db
    volumes:
      - mongodb_data:/data/db
    networks:
      - vector_hacking
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh "mongodb://localhost:27017/?directConnection=true" --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================================================
  # MongoDB Express (Optional)
  # ==========================================================================
  mongo-express:
    image: mongo-express:latest
    container_name: vector_hacking_mongo_express
    restart: unless-stopped
    ports:
      - "${MONGO_EXPRESS_PORT:-8081}:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: password
      ME_CONFIG_MONGODB_URL: mongodb://admin:password@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - vector_hacking
    profiles:
      - db-ui

volumes:
  mongodb_data:

networks:
  vector_hacking:
    driver: bridge

