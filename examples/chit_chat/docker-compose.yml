# ============================================================================
# Docker Compose Configuration for ChitChat Example
# ============================================================================

services:
  # ChitChat Application
  app:
    build:
      context: ../..
      dockerfile: examples/chit_chat/Dockerfile
      args:
        APP_USER: appuser
        APP_UID: 1000
        APP_GID: 1000
    container_name: chit_chat_app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8000}:8000"
    environment:
      - MONGO_URI=${MONGO_URI:-mongodb://mongodb:27017/}
      - MONGO_DB_NAME=${MONGO_DB_NAME:-conversations_db}
      - APP_SLUG=${APP_SLUG:-conversations}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-conversations_demo_secret_key_change_in_production}
      # Azure OpenAI Configuration (recommended)
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY:-}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME:-gpt-4o}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION:-2024-02-15-preview}
      # Alternative: Standard OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4-turbo-preview}
      # AI Provider Selection
      - AI_PROVIDER=${AI_PROVIDER:-azure}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - mdb_engine_network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # MongoDB Atlas Local (No Authentication)
  # Accessible from MongoDB Compass using:
  # Connection String: mongodb://localhost:27017/
  # Or use: mongodb://127.0.0.1:27017/
  mongodb:
    image: mongodb/mongodb-atlas-local:latest
    container_name: chit_chat_mongodb
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"  # Exposed for MongoDB Compass access
    environment:
      # No authentication - open access for development
      MONGODB_INITDB_DATABASE: ${MONGO_DB_NAME:-conversations_db}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - mdb_engine_network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh "mongodb://localhost:27017/?directConnection=true" --quiet
      # No authentication required
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

networks:
  mdb_engine_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
