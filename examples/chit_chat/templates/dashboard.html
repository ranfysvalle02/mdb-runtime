{% extends "base.html" %}

{% block title %}Dashboard - ChitChat{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: var(--mongodb-bg-tertiary);
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid var(--mongodb-green);
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--mongodb-green);
        margin: 10px 0;
    }

    .stat-label {
        font-size: 14px;
        opacity: 0.8;
    }

    .tasks-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .task-list {
        display: grid;
        gap: 12px;
    }

    .task-item {
        background: var(--mongodb-bg-tertiary);
        border: 1px solid var(--mongodb-border);
        border-radius: 6px;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: start;
        transition: border-color 0.2s;
    }

    .task-item:hover {
        border-color: var(--mongodb-green);
    }

    .task-content {
        flex: 1;
    }

    .task-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .task-meta {
        display: flex;
        gap: 15px;
        font-size: 12px;
        opacity: 0.7;
        margin-top: 8px;
    }

    .task-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        margin-right: 8px;
    }

    .badge-pending {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }

    .badge-in-progress {
        background: rgba(33, 150, 243, 0.2);
        color: #2196f3;
    }

    .badge-completed {
        background: rgba(0, 237, 100, 0.2);
        color: var(--mongodb-green);
    }

    .badge-high {
        background: rgba(248, 81, 73, 0.2);
        color: #f85149;
    }

    .badge-medium {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }

    .badge-low {
        background: rgba(144, 202, 249, 0.2);
        color: #90caf9;
    }

    .task-actions {
        display: flex;
        gap: 8px;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: var(--mongodb-bg-secondary);
        border: 1px solid var(--mongodb-border);
        border-radius: 8px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div></div>
    <div>
        <button onclick="openCreateModal()" class="btn">+ New Task</button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Tasks</div>
        <div class="stat-value">{{ stats.total }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-value">{{ stats.pending }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Completed</div>
        <div class="stat-value">{{ stats.completed }}</div>
    </div>
</div>

<div class="card">
    <div class="tasks-header">
        <h2>Your Tasks</h2>
        <div>
            <select id="status-filter" onchange="filterTasks()" style="padding: 8px; background: var(--mongodb-bg-tertiary); border: 1px solid var(--mongodb-border); border-radius: 6px; color: var(--mongodb-text);">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
            </select>
        </div>
    </div>

    <div class="task-list" id="task-list">
        {% for task in tasks %}
        <div class="task-item" data-task-id="{{ task._id }}" data-status="{{ task.status }}">
            <div class="task-content">
                <div class="task-title">
                    <span class="task-badge badge-{{ task.status }}">{{ task.status }}</span>
                    <span class="task-badge badge-{{ task.priority }}">{{ task.priority }}</span>
                    {{ task.title }}
                </div>
                {% if task.description %}
                <p style="opacity: 0.8; margin-top: 8px; font-size: 14px;">{{ task.description }}</p>
                {% endif %}
                <div class="task-meta">
                    <span>Created: {{ task.created_at.strftime('%Y-%m-%d %H:%M') if task.created_at else 'N/A' }}</span>
                </div>
            </div>
            <div class="task-actions">
                <button onclick="openEditModal('{{ task._id }}', '{{ task.title }}', '{{ task.description }}', '{{ task.status }}', '{{ task.priority }}')" class="btn btn-secondary btn-small">Edit</button>
                <button onclick="deleteTask('{{ task._id }}')" class="btn btn-secondary btn-small" style="background: rgba(248, 81, 73, 0.2); color: #f85149;">Delete</button>
            </div>
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; opacity: 0.6;">
            <p>No tasks yet. Create your first task!</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create/Edit Task Modal -->
<div id="task-modal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title" style="margin-bottom: 20px;">Create Task</h2>
        <form id="task-form" onsubmit="saveTask(event)">
            <input type="hidden" id="task-id" name="task_id">

            <div class="form-group">
                <label for="task-title">Title</label>
                <input type="text" id="task-title" name="title" required>
            </div>

            <div class="form-group">
                <label for="task-description">Description</label>
                <textarea id="task-description" name="description" rows="4"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="task-status">Status</label>
                    <select id="task-status" name="status" required>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="task-priority">Priority</label>
                    <select id="task-priority" name="priority" required>
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn" style="flex: 1;">Save</button>
                <button type="button" onclick="closeModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

function openCreateModal() {
    document.getElementById('modal-title').textContent = 'Create Task';
    document.getElementById('task-form').reset();
    document.getElementById('task-id').value = '';
    document.getElementById('task-modal').classList.add('active');
}

function openEditModal(taskId, title, description, status, priority) {
    document.getElementById('modal-title').textContent = 'Edit Task';
    document.getElementById('task-id').value = taskId;
    document.getElementById('task-title').value = title;
    document.getElementById('task-description').value = description || '';
    document.getElementById('task-status').value = status;
    document.getElementById('task-priority').value = priority;
    document.getElementById('task-modal').classList.add('active');
}

function closeModal() {
    document.getElementById('task-modal').classList.remove('active');
}

async function saveTask(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const taskId = formData.get('task_id');
    const url = taskId ? `/api/tasks/${taskId}` : '/api/tasks';
    const method = taskId ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
            body: formData
        });

        if (response.ok) {
            closeModal();
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to save task'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }

    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to delete task'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function filterTasks() {
    const filter = document.getElementById('status-filter').value;
    const tasks = document.querySelectorAll('.task-item');

    tasks.forEach(task => {
        if (!filter || task.dataset.status === filter) {
            task.style.display = '';
        } else {
            task.style.display = 'none';
        }
    });
}

// WebSocket connection for real-time updates
let ws = null;
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws`;

    ws = new WebSocket(wsUrl);

    ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        if (message.type === 'task_created' || message.type === 'task_updated' || message.type === 'task_deleted') {
            // Reload to show updates
            location.reload();
        }
    };

    ws.onclose = () => {
        // Reconnect after 3 seconds
        setTimeout(connectWebSocket, 3000);
    };
}

// Connect WebSocket on page load
if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
    connectWebSocket();
}
</script>

<!-- AI Chat Component -->
{% include "ai_chat.html" %}
{% endblock %}
