# ============================================================================
# Docker Compose Configuration for OSO Hello World Example
# ============================================================================

services:
  # OSO Dev Server - Local OSO Cloud API for development
  oso-dev:
    image: public.ecr.aws/osohq/dev-server:latest
    container_name: oso_hello_world_oso_dev
    restart: unless-stopped
    ports:
      - "${OSO_PORT:-8080}:8080"
    volumes:
      # Mount policy file so OSO can load it
      - ./main.polar:/policies/main.polar:ro
      # Don't mount data directory - let OSO use its default location
      # Data will be lost on container restart, but that's fine for development
    # Command to run the server and watch your policy file for changes
    command: ["--watch-for-changes", "/policies/main.polar"]
    networks:
      - mdb_engine_network
    # Note: Healthcheck disabled - OSO Dev Server may not have standard health endpoint
    # The app will handle connection failures gracefully

  # OSO Hello World Application
  app:
    build:
      context: ../..
      dockerfile: examples/oso_hello_world/Dockerfile
      args:
        APP_USER: appuser
        APP_UID: 1000
        APP_GID: 1000
    container_name: oso_hello_world_app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8000}:8000"
    environment:
      - MONGO_URI=${MONGO_URI:-mongodb://mongodb:27017/}
      - MONGO_DB_NAME=${MONGO_DB_NAME:-oso_hello_world_db}
      - APP_SLUG=${APP_SLUG:-oso_hello_world}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-oso_hello_world_demo_secret_key_change_in_production}
      # OSO Cloud Configuration
      # Point SDK to local OSO Dev Server
      - OSO_URL=http://oso-dev:8080
      # Authentication token (Dev Server accepts any dummy token)
      - OSO_AUTH=${OSO_AUTH:-e_0123456789_12345_osotesttoken01xiIn}
    depends_on:
      oso-dev:
        condition: service_started
      mongodb:
        condition: service_healthy
    networks:
      - mdb_engine_network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # MongoDB Atlas Local (No Authentication)
  # Accessible from MongoDB Compass using:
  # Connection String: mongodb://localhost:27017/
  mongodb:
    image: mongodb/mongodb-atlas-local:latest
    container_name: oso_hello_world_mongodb
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"  # Exposed for MongoDB Compass access
    environment:
      # No authentication - open access for development
      MONGODB_INITDB_DATABASE: ${MONGO_DB_NAME:-oso_hello_world_db}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - mdb_engine_network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh "mongodb://localhost:27017/?directConnection=true" --quiet
      # No authentication required
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  # OSO data volume removed - using container's default location instead

networks:
  mdb_engine_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
