<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }}</title>
    <!-- Note: Tailwind CDN is used for development. For production, use PostCSS plugin or Tailwind CLI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"Fira Code"', 'monospace'],
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.05)',
                            200: 'rgba(255, 255, 255, 0.1)',
                            300: 'rgba(255, 255, 255, 0.2)',
                            border: 'rgba(255, 255, 255, 0.08)',
                        },
                        accent: {
                            DEFAULT: '#6366f1',
                            glow: '#818cf8',
                        }
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            overflow-x: hidden;
        }
        
        /* Aurora Background */
        .aurora-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #0f172a 100%);
            overflow: hidden;
        }
        .aurora-blob {
            position: absolute;
            filter: blur(80px);
            opacity: 0.6;
            animation: blob 20s infinite alternate;
        }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #4338ca; animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: #3730a3; animation-delay: 2s; }
        .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #312e81; animation-delay: 4s; }

        /* Modern Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <div class="aurora-bg">
        <div class="aurora-blob blob-1"></div>
        <div class="aurora-blob blob-2"></div>
        <div class="aurora-blob blob-3"></div>
    </div>

    <nav class="sticky top-0 z-40 glass-panel border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600/20 p-2 rounded-lg border border-indigo-500/30">
                        <i data-lucide="trending-up" class="h-6 w-6 text-indigo-400"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-white">Alpaca <span class="text-indigo-400">Paper Trading</span></span>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex flex-col items-end mr-2">
                        <span class="text-sm font-medium text-white">{{ user.email }}</span>
                        <div class="flex gap-1">
                            {% for role in roles %}
                            <span class="text-[10px] uppercase tracking-wider px-1.5 py-0.5 rounded bg-indigo-500/10 text-indigo-400 border border-indigo-500/20">{{ role }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="h-8 w-px bg-white/10 mx-1"></div>
                    <a href="{{ auth_hub_url }}/dashboard" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-lg transition-all" title="Hub">
                        <i data-lucide="grid" class="h-5 w-5"></i>
                    </a>
                    <form id="logout-form" method="POST" action="/logout" class="inline">
                        <button type="submit" class="p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg transition-all" title="Logout">
                            <i data-lucide="log-out" class="h-5 w-5"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8 z-10 relative">
        
        <!-- Loading State -->
        <div id="loading-state" class="hidden flex items-center justify-center py-20">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mb-4"></div>
                <p class="text-gray-400">Loading account information...</p>
            </div>
        </div>

        <!-- No Account State -->
        <div id="no-account-state" class="{% if has_account %}hidden{% endif %}">
            <div class="max-w-2xl mx-auto mt-20">
                <div class="glass-panel rounded-2xl p-8 text-center">
                    <div class="bg-indigo-500/10 p-6 rounded-full w-24 h-24 mx-auto mb-6 flex items-center justify-center border border-indigo-500/20">
                        <i data-lucide="wallet" class="h-12 w-12 text-indigo-400"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-white mb-4">Get Started with Paper Trading</h1>
                    <p class="text-gray-400 mb-8 max-w-md mx-auto">
                        Create a free Alpaca paper trading account to practice trading with virtual money. 
                        No risk, real market data.
                    </p>
                    <button id="register-btn" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-indigo-500/20 flex items-center gap-2 mx-auto">
                        <i data-lucide="plus" class="h-5 w-5"></i>
                        Create Paper Trading Account
                    </button>
                </div>
            </div>
        </div>

        <!-- Account Display State -->
        <div id="account-state" class="{% if not has_account %}hidden{% endif %}">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">Paper Trading Account</h1>
                <p class="text-gray-400">Manage your Alpaca paper trading account</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Account Status Card -->
                <div class="glass-panel p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm text-gray-400 font-medium">Account Status</p>
                        <div class="bg-emerald-500/10 p-2 rounded-lg border border-emerald-500/20">
                            <i data-lucide="check-circle" class="h-5 w-5 text-emerald-400"></i>
                        </div>
                    </div>
                    <h3 id="account-status" class="text-2xl font-bold text-white">Active</h3>
                </div>

                <!-- Portfolio Value Card -->
                <div class="glass-panel p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm text-gray-400 font-medium">Portfolio Value</p>
                        <div class="bg-indigo-500/10 p-2 rounded-lg border border-indigo-500/20">
                            <i data-lucide="dollar-sign" class="h-5 w-5 text-indigo-400"></i>
                        </div>
                    </div>
                    <h3 id="portfolio-value" class="text-2xl font-bold text-white">$0.00</h3>
                </div>

                <!-- Buying Power Card -->
                <div class="glass-panel p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm text-gray-400 font-medium">Buying Power</p>
                        <div class="bg-blue-500/10 p-2 rounded-lg border border-blue-500/20">
                            <i data-lucide="zap" class="h-5 w-5 text-blue-400"></i>
                        </div>
                    </div>
                    <h3 id="buying-power" class="text-2xl font-bold text-white">$0.00</h3>
                </div>

                <!-- Cash Card -->
                <div class="glass-panel p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm text-gray-400 font-medium">Cash</p>
                        <div class="bg-purple-500/10 p-2 rounded-lg border border-purple-500/20">
                            <i data-lucide="wallet" class="h-5 w-5 text-purple-400"></i>
                        </div>
                    </div>
                    <h3 id="cash" class="text-2xl font-bold text-white">$0.00</h3>
                </div>
            </div>

            <!-- Account Details Card -->
            <div class="glass-panel rounded-2xl p-6 mb-8">
                <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                    <i data-lucide="info" class="h-6 w-6 text-indigo-400"></i>
                    Account Details
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Account Number</p>
                        <p id="account-number" class="text-white font-mono text-sm">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Equity</p>
                        <p id="equity" class="text-white font-semibold">$0.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Currency</p>
                        <p id="currency" class="text-white">USD</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Day Trading Buying Power</p>
                        <p id="daytrading-buying-power" class="text-white">$0.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Regulatory Buying Power</p>
                        <p id="regt-buying-power" class="text-white">$0.00</p>
                    </div>
                </div>
            </div>

            <!-- Trading Interface -->
            <div class="glass-panel rounded-2xl p-6 mb-8">
                <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                    <i data-lucide="trending-up" class="h-6 w-6 text-indigo-400"></i>
                    Place Trade
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Symbol</label>
                        <input type="text" id="trade-symbol" placeholder="AAPL" class="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Quantity</label>
                        <input type="number" id="trade-qty" placeholder="10" min="1" step="1" class="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Order Type</label>
                        <select id="trade-order-type" class="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-indigo-500">
                            <option value="market">Market</option>
                            <option value="limit">Limit</option>
                        </select>
                    </div>
                    <div id="limit-price-container" class="hidden">
                        <label class="block text-sm text-gray-400 mb-2">Limit Price</label>
                        <input type="number" id="trade-limit-price" placeholder="150.00" step="0.01" class="w-full px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
                    </div>
                </div>
                <div class="flex gap-4 mt-4">
                    <button id="buy-btn" class="flex-1 px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-emerald-500/20 flex items-center justify-center gap-2">
                        <i data-lucide="arrow-up" class="h-5 w-5"></i>
                        Buy
                    </button>
                    <button id="sell-btn" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-red-500/20 flex items-center justify-center gap-2">
                        <i data-lucide="arrow-down" class="h-5 w-5"></i>
                        Sell
                    </button>
                </div>
            </div>

            <!-- Positions Table -->
            <div class="glass-panel rounded-2xl p-6 mb-8">
                <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                    <i data-lucide="briefcase" class="h-6 w-6 text-indigo-400"></i>
                    Positions
                </h2>
                <div id="positions-container">
                    <p class="text-gray-400 text-center py-4">No positions yet. Place your first trade!</p>
                </div>
            </div>

            <!-- Order History -->
            <div class="glass-panel rounded-2xl p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="history" class="h-6 w-6 text-indigo-400"></i>
                        Order History
                    </h2>
                    <button onclick="fetchOrders()" class="px-4 py-2 bg-indigo-600/50 hover:bg-indigo-600 text-white rounded-lg text-sm font-medium transition-all flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                        Refresh
                    </button>
                </div>
                <div id="orders-container">
                    <p class="text-gray-400 text-center py-4">No orders yet.</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-4">
                <button id="fund-btn" class="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-emerald-500/20 flex items-center gap-2">
                    <i data-lucide="dollar-sign" class="h-5 w-5"></i>
                    Fund Account ($1k)
                </button>
                <button id="refresh-btn" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-indigo-500/20 flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="h-5 w-5"></i>
                    Refresh Account Data
                </button>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-6 right-6 z-[70] translate-y-24 opacity-0 transition-all duration-500 flex items-center gap-4 p-4 rounded-xl glass-panel border-l-4 border-indigo-500 shadow-2xl min-w-[300px]">
            <div id="toast-icon-bg" class="p-2 rounded-full bg-indigo-500/20">
                <i id="toast-icon" data-lucide="check" class="h-5 w-5 text-indigo-400"></i>
            </div>
            <div>
                <h4 id="toast-title" class="font-bold text-white text-sm">Success</h4>
                <p id="toast-msg" class="text-xs text-gray-400 mt-0.5">Operation completed.</p>
            </div>
        </div>

    </main>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Cookie helper function
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value || 0);
        }

        // Toast notification
        let toastTimer;
        function showToast(title, msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const tTitle = document.getElementById('toast-title');
            const tMsg = document.getElementById('toast-msg');
            const iconBg = document.getElementById('toast-icon-bg');
            
            tTitle.textContent = title;
            tMsg.textContent = msg;
            
            const colors = {
                success: 'text-emerald-400',
                error: 'text-red-400',
                info: 'text-indigo-400'
            };
            const bgs = {
                success: 'bg-emerald-500/20',
                error: 'bg-red-500/20',
                info: 'bg-indigo-500/20'
            };
            
            icon.className = `h-5 w-5 ${colors[type]}`;
            iconBg.className = `p-2 rounded-full ${bgs[type]}`;
            toast.className = `fixed bottom-6 right-6 z-[70] transition-all duration-500 flex items-center gap-4 p-4 rounded-xl glass-panel shadow-2xl min-w-[300px] border-l-4 ${type === 'success' ? 'border-emerald-500' : type === 'error' ? 'border-red-500' : 'border-indigo-500'}`;

            toast.classList.remove('translate-y-24', 'opacity-0');
            
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toast.classList.add('translate-y-24', 'opacity-0');
            }, 3000);
        }

        // Update account display
        function updateAccountDisplay(account) {
            if (!account) return;

            document.getElementById('account-status').textContent = (account.status || 'active').charAt(0).toUpperCase() + (account.status || 'active').slice(1);
            document.getElementById('portfolio-value').textContent = formatCurrency(account.portfolio_value || account.equity || 0);
            document.getElementById('buying-power').textContent = formatCurrency(account.buying_power || 0);
            document.getElementById('cash').textContent = formatCurrency(account.virtual_cash || account.cash || 0);
            document.getElementById('account-number').textContent = 'Virtual Account';
            document.getElementById('equity').textContent = formatCurrency(account.equity || 0);
            document.getElementById('currency').textContent = account.currency || 'USD';
            document.getElementById('daytrading-buying-power').textContent = formatCurrency(account.buying_power || 0);
            document.getElementById('regt-buying-power').textContent = formatCurrency(account.buying_power || 0);
        }

        // Fetch account details
        async function fetchAccountDetails() {
            try {
                const csrfToken = getCookie('csrf_token');
                const headers = {
                    'Content-Type': 'application/json',
                };
                if (csrfToken) {
                    headers['X-CSRF-Token'] = csrfToken;
                }

                const res = await fetch('/api/alpaca/account', {
                    headers: headers,
                    credentials: 'same-origin'
                });
                if (res.status === 404) {
                    // No account found, show registration UI
                    document.getElementById('no-account-state').classList.remove('hidden');
                    document.getElementById('account-state').classList.add('hidden');
                    return;
                }
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to fetch account details');
                }

                const data = await res.json();
                if (data.success && data.account) {
                    updateAccountDisplay(data.account);
                    document.getElementById('no-account-state').classList.add('hidden');
                    document.getElementById('account-state').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error fetching account:', error);
                showToast('Error', error.message, 'error');
            }
        }

        // Register account
        async function registerAccount() {
            const btn = document.getElementById('register-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="inline-block animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mr-2"></div> Creating account...';

            try {
                const csrfToken = getCookie('csrf_token');
                if (!csrfToken) {
                    throw new Error('CSRF token not found. Please refresh the page.');
                }

                const res = await fetch('/api/alpaca/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'same-origin'
                });

                const data = await res.json();

                if (!res.ok) {
                    const errorMsg = data.error || data.detail || `Failed to create account (${res.status})`;
                    throw new Error(errorMsg);
                }

                if (data.success && data.account) {
                    updateAccountDisplay(data.account);
                    document.getElementById('no-account-state').classList.add('hidden');
                    document.getElementById('account-state').classList.remove('hidden');
                    showToast('Success', 'Paper trading account created successfully!', 'success');
                }
            } catch (error) {
                console.error('Error registering account:', error);
                showToast('Error', error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Fund account
        async function fundAccount() {
            const btn = document.getElementById('fund-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="inline-block animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mr-2"></div> Funding account...';

            try {
                const csrfToken = getCookie('csrf_token');
                if (!csrfToken) {
                    throw new Error('CSRF token not found. Please refresh the page.');
                }

                const res = await fetch('/api/alpaca/fund', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'same-origin'
                });

                const data = await res.json();

                if (!res.ok) {
                    const errorMsg = data.error || data.detail || `Failed to fund account (${res.status})`;
                    throw new Error(errorMsg);
                }

                if (data.success) {
                    showToast('Success', data.message || 'Account funded successfully!', 'success');
                    // Refresh account details to show updated balance
                    setTimeout(() => {
                        fetchAccountDetails();
                    }, 1000);
                }
            } catch (error) {
                console.error('Error funding account:', error);
                showToast('Error', error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Show/hide limit price input
        document.getElementById('trade-order-type')?.addEventListener('change', (e) => {
            const limitContainer = document.getElementById('limit-price-container');
            if (e.target.value === 'limit') {
                limitContainer.classList.remove('hidden');
            } else {
                limitContainer.classList.add('hidden');
            }
        });

        // Execute trade
        async function executeTrade(side) {
            const symbol = document.getElementById('trade-symbol')?.value.trim().toUpperCase();
            const qty = parseFloat(document.getElementById('trade-qty')?.value);
            const orderType = document.getElementById('trade-order-type')?.value;
            const limitPrice = orderType === 'limit' ? parseFloat(document.getElementById('trade-limit-price')?.value) : null;

            if (!symbol) {
                showToast('Error', 'Please enter a symbol', 'error');
                return;
            }

            if (!qty || qty <= 0) {
                showToast('Error', 'Please enter a valid quantity', 'error');
                return;
            }

            if (orderType === 'limit' && (!limitPrice || limitPrice <= 0)) {
                showToast('Error', 'Please enter a valid limit price', 'error');
                return;
            }

            const btn = side === 'buy' ? document.getElementById('buy-btn') : document.getElementById('sell-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="inline-block animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>';

            try {
                const csrfToken = getCookie('csrf_token');
                if (!csrfToken) {
                    throw new Error('CSRF token not found. Please refresh the page.');
                }

                const res = await fetch('/api/alpaca/trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        symbol: symbol,
                        side: side,
                        qty: qty,
                        order_type: orderType,
                        limit_price: limitPrice
                    })
                });

                let data;
                try {
                    data = await res.json();
                } catch {
                    // Response might not be JSON
                    throw new Error(`Failed to execute trade (${res.status})`);
                }

                if (!res.ok) {
                    // Handle wash trade error with special UI
                    if (data.error_code === 'WASH_TRADE' || (data.error && (data.error.includes('wash trade') || data.error.includes('opposite side')))) {
                        const errorMsg = data.error || 'Wash trade detected';
                        const conflictingOrderId = data.conflicting_order_id;
                        
                        showToast('Wash Trade Detected', errorMsg, 'error');
                        
                        // Show a more detailed error with cancel option
                        setTimeout(() => {
                            const cancelMsg = conflictingOrderId 
                                ? `${errorMsg}\n\nYou can cancel the conflicting order from the Order History below, or click OK to refresh orders.`
                                : `${errorMsg}\n\nPlease check your Order History and cancel any pending orders of the opposite side.`;
                            
                            if (confirm(cancelMsg)) {
                                fetchOrders();
                            }
                        }, 500);
                        return;
                    }
                    
                    // Handle other errors
                    const errorMsg = data.error || data.detail || data.message || `Failed to execute trade (${res.status})`;
                    throw new Error(errorMsg);
                }

                if (data.success) {
                    showToast('Success', data.message || 'Order submitted successfully!', 'success');
                    // Clear form
                    document.getElementById('trade-symbol').value = '';
                    document.getElementById('trade-qty').value = '';
                    document.getElementById('trade-limit-price').value = '';
                    // Refresh data
                    setTimeout(() => {
                        fetchAccountDetails();
                        fetchPositions();
                        fetchOrders();
                    }, 1000);
                }
            } catch (error) {
                console.error('Error executing trade:', error);
                let errorMsg = error.message;
                
                // Try to parse JSON error messages
                try {
                    const errorObj = JSON.parse(error.message);
                    if (errorObj.error) {
                        errorMsg = errorObj.error;
                    } else if (errorObj.message) {
                        errorMsg = errorObj.message;
                    }
                } catch {
                    // Not JSON, use as-is
                }
                
                // Check for wash trade in error message
                if (errorMsg.includes('wash trade') || errorMsg.includes('opposite side') || errorMsg.includes('WASH_TRADE')) {
                    showToast('Wash Trade Detected', 'You have a pending order of the opposite side. Please cancel it first or wait for it to fill.', 'error');
                    setTimeout(() => fetchOrders(), 1000);
                } else {
                    showToast('Error', errorMsg, 'error');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Fetch positions
        async function fetchPositions() {
            try {
                const csrfToken = getCookie('csrf_token');
                const headers = {
                    'Content-Type': 'application/json',
                };
                if (csrfToken) {
                    headers['X-CSRF-Token'] = csrfToken;
                }

                const res = await fetch('/api/alpaca/positions', {
                    headers: headers,
                    credentials: 'same-origin'
                });

                if (!res.ok) {
                    throw new Error('Failed to fetch positions');
                }

                const data = await res.json();
                const container = document.getElementById('positions-container');

                if (data.success && data.positions && data.positions.length > 0) {
                    container.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-white/10">
                                        <th class="text-left py-3 px-4 text-sm text-gray-400 font-medium">Symbol</th>
                                        <th class="text-right py-3 px-4 text-sm text-gray-400 font-medium">Shares</th>
                                        <th class="text-right py-3 px-4 text-sm text-gray-400 font-medium">Avg Price</th>
                                        <th class="text-right py-3 px-4 text-sm text-gray-400 font-medium">Cost Basis</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.positions.map(pos => `
                                        <tr class="border-b border-white/5 hover:bg-white/5">
                                            <td class="py-3 px-4 text-white font-medium">${pos.symbol}</td>
                                            <td class="py-3 px-4 text-right text-white">${pos.shares}</td>
                                            <td class="py-3 px-4 text-right text-white">${formatCurrency(pos.avg_price)}</td>
                                            <td class="py-3 px-4 text-right text-white">${formatCurrency(pos.cost_basis)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p class="text-gray-400 text-center py-4">No positions yet. Place your first trade!</p>';
                }
            } catch (error) {
                console.error('Error fetching positions:', error);
            }
        }

        // Cancel order
        async function cancelOrder(orderId) {
            if (!confirm('Are you sure you want to cancel this order?')) {
                return;
            }

            try {
                const csrfToken = getCookie('csrf_token');
                if (!csrfToken) {
                    throw new Error('CSRF token not found. Please refresh the page.');
                }

                const res = await fetch(`/api/alpaca/orders/${orderId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'same-origin'
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || `Failed to cancel order (${res.status})`);
                }

                if (data.success) {
                    showToast('Success', data.message || 'Order cancelled successfully!', 'success');
                    // Refresh orders and positions
                    setTimeout(() => {
                        fetchOrders();
                        fetchPositions();
                        fetchAccountDetails();
                    }, 500);
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                showToast('Error', error.message, 'error');
            }
        }

        // Fetch orders
        async function fetchOrders() {
            try {
                const csrfToken = getCookie('csrf_token');
                const headers = {
                    'Content-Type': 'application/json',
                };
                if (csrfToken) {
                    headers['X-CSRF-Token'] = csrfToken;
                }

                const res = await fetch('/api/alpaca/orders', {
                    headers: headers,
                    credentials: 'same-origin'
                });

                if (!res.ok) {
                    throw new Error('Failed to fetch orders');
                }

                const data = await res.json();
                const container = document.getElementById('orders-container');

                if (data.success && data.orders && data.orders.length > 0) {
                    container.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-white/10">
                                        <th class="text-left py-3 px-4 text-sm text-gray-400 font-medium">Symbol</th>
                                        <th class="text-left py-3 px-4 text-sm text-gray-400 font-medium">Side</th>
                                        <th class="text-right py-3 px-4 text-sm text-gray-400 font-medium">Qty</th>
                                        <th class="text-right py-3 px-4 text-sm text-gray-400 font-medium">Price</th>
                                        <th class="text-left py-3 px-4 text-sm text-gray-400 font-medium">Status</th>
                                        <th class="text-left py-3 px-4 text-sm text-gray-400 font-medium">Time</th>
                                        <th class="text-center py-3 px-4 text-sm text-gray-400 font-medium">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.orders.map(order => {
                                        const sideColor = order.side === 'buy' ? 'text-emerald-400' : 'text-red-400';
                                        const statusColor = order.status === 'filled' ? 'text-emerald-400' : 
                                                          order.status === 'rejected' || order.status === 'cancelled' ? 'text-red-400' : 
                                                          'text-yellow-400';
                                        const canCancel = ['pending', 'accepted', 'pending_new', 'accepted_for_bidding', 'pending_replace'].includes(order.status?.toLowerCase()) && order.status?.toLowerCase() !== 'pending_cancel';
                                        const orderId = order.alpaca_order_id || order.client_order_id || order._id;
                                        const priceDisplay = order.filled_avg_price ? formatCurrency(order.filled_avg_price) : 
                                                           (order.limit_price ? `Limit: ${formatCurrency(order.limit_price)}` : 
                                                           (order.order_type === 'market' ? 'Market' : '-'));
                                        return `
                                            <tr class="border-b border-white/5 hover:bg-white/5">
                                                <td class="py-3 px-4 text-white font-medium">${order.symbol}</td>
                                                <td class="py-3 px-4 ${sideColor} font-medium uppercase">${order.side}</td>
                                                <td class="py-3 px-4 text-right text-white">${order.qty}${order.filled_qty && order.filled_qty > 0 ? ` (${order.filled_qty} filled)` : ''}</td>
                                                <td class="py-3 px-4 text-right text-white">${priceDisplay}</td>
                                                <td class="py-3 px-4 ${statusColor} font-medium capitalize">
                                                    ${order.status || 'pending'}
                                                    ${(order.status === 'pending' || order.status === 'accepted' || order.status === 'pending_cancel') ? ' <span class="text-xs">‚è≥</span>' : ''}
                                                </td>
                                                <td class="py-3 px-4 text-gray-400 text-sm">${order.submitted_at ? new Date(order.submitted_at).toLocaleString() : '-'}</td>
                                                <td class="py-3 px-4 text-center">
                                                    ${canCancel ? `
                                                        <button onclick="cancelOrder('${orderId}')" 
                                                                class="px-3 py-1 text-xs bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded border border-red-500/30 transition-colors">
                                                            Cancel
                                                        </button>
                                                    ` : '-'}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p class="text-gray-400 text-center py-4">No orders yet.</p>';
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
            }
        }

        // Event listeners
        document.getElementById('register-btn')?.addEventListener('click', registerAccount);
        document.getElementById('fund-btn')?.addEventListener('click', fundAccount);
        document.getElementById('buy-btn')?.addEventListener('click', () => executeTrade('buy'));
        document.getElementById('sell-btn')?.addEventListener('click', () => executeTrade('sell'));
        document.getElementById('refresh-btn')?.addEventListener('click', () => {
            fetchAccountDetails();
            fetchPositions();
            fetchOrders();
            showToast('Refreshing', 'Updating account data...', 'info');
        });

        // Load account details on page load if account exists
        {% if has_account %}
        document.addEventListener('DOMContentLoaded', () => {
            fetchAccountDetails();
            fetchPositions();
            fetchOrders();
        });
        {% endif %}
    </script>
</body>
</html>
