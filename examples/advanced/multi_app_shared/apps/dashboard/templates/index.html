<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard (SSO)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f0f12;
            --card: #1a1a1f;
            --accent: #8b5cf6;
            --clicker: #06b6d4;
            --admin: #f59e0b;
            --text: #f4f4f5;
            --muted: #71717a;
            --success: #22c55e;
            --error: #ef4444;
            --sso: #10b981;
            --cross: #ec4899;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 2rem; }
        .container { max-width: 900px; margin: 0 auto; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
        h1 i { color: var(--accent); }
        
        .card { background: var(--card); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; }
        .card h2 { font-size: 1rem; color: var(--muted); margin-bottom: 1rem; }
        
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge.clicker { background: rgba(6, 182, 212, 0.2); color: var(--clicker); }
        .badge.tracker { background: rgba(139, 92, 246, 0.2); color: var(--accent); }
        .badge.admin { background: rgba(245, 158, 11, 0.2); color: var(--admin); }
        .badge.sso { background: rgba(16, 185, 129, 0.2); color: var(--sso); }
        .badge.cross { background: rgba(236, 72, 153, 0.2); color: var(--cross); }
        
        .sso-banner { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid var(--sso); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; }
        .sso-banner i { color: var(--sso); font-size: 1.5rem; }
        .sso-banner .text { flex: 1; }
        .sso-banner .text strong { color: var(--sso); }
        .sso-banner a { color: var(--sso); text-decoration: underline; }
        
        .cross-banner { background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid var(--cross); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; }
        .cross-banner i { color: var(--cross); font-size: 1.5rem; }
        .cross-banner .text { flex: 1; }
        .cross-banner .text strong { color: var(--cross); }
        .cross-banner code { background: var(--bg); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem; }
        
        .demo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        @media (max-width: 600px) { .demo-grid { grid-template-columns: 1fr; } }
        
        .demo-card { background: var(--bg); border: 2px solid transparent; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .demo-card:hover { transform: translateY(-2px); }
        .demo-card.clicker { border-color: var(--clicker); opacity: 0.5; }
        .demo-card.tracker { border-color: var(--accent); }
        .demo-card.admin { border-color: var(--admin); }
        .demo-card h3 { margin: 0.5rem 0; }
        .demo-card p { font-size: 0.8rem; color: var(--muted); }
        .demo-card .access { font-size: 0.7rem; margin-top: 0.5rem; }
        .demo-card .access.yes { color: var(--success); }
        .demo-card .access.no { color: var(--error); }
        
        .avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 1.25rem; }
        .avatar.clicker { background: rgba(6, 182, 212, 0.2); color: var(--clicker); }
        .avatar.tracker { background: rgba(139, 92, 246, 0.2); color: var(--accent); }
        .avatar.admin { background: rgba(245, 158, 11, 0.2); color: var(--admin); }
        
        .btn { padding: 0.75rem 1.5rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-secondary { background: transparent; border: 1px solid var(--muted); color: var(--text); }
        
        .user-bar { display: flex; align-items: center; gap: 1rem; }
        .user-bar .info { flex: 1; }
        
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        @media (max-width: 600px) { .stats { grid-template-columns: repeat(2, 1fr); } }
        .stat { background: var(--bg); padding: 1.5rem; border-radius: 12px; text-align: center; }
        .stat .num { font-size: 2rem; font-weight: 800; color: var(--accent); }
        .stat .label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; }
        
        .role-bars { display: flex; gap: 1rem; margin-top: 1rem; }
        .role-bar { flex: 1; background: var(--bg); padding: 1rem; border-radius: 8px; text-align: center; }
        .role-bar .num { font-size: 1.5rem; font-weight: 700; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--bg); }
        th { color: var(--muted); font-size: 0.75rem; text-transform: uppercase; }
        
        .msg { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .msg.success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .msg.error { background: rgba(239, 68, 68, 0.2); color: var(--error); }
        .msg.info { background: rgba(139, 92, 246, 0.1); color: var(--accent); }
        
        .denied { text-align: center; padding: 3rem; }
        .denied i { font-size: 4rem; color: var(--error); margin-bottom: 1rem; }
        .denied h3 { margin-bottom: 0.5rem; }
        .denied p { color: var(--muted); margin-bottom: 1.5rem; }
        
        .admin-panel { border: 2px dashed var(--admin); border-radius: 12px; padding: 1.5rem; margin-top: 1rem; }
        .admin-panel h3 { color: var(--admin); margin-bottom: 1rem; }
        .admin-form { display: flex; gap: 1rem; flex-wrap: wrap; }
        .admin-form input, .admin-form select { flex: 1; min-width: 150px; padding: 0.75rem; background: var(--bg); border: 1px solid var(--muted); border-radius: 8px; color: var(--text); }
        
        nav a { color: var(--muted); text-decoration: none; margin-left: 1rem; }
        nav a:hover { color: var(--text); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> Analytics Dashboard <span class="badge sso">SSO</span></h1>
            <nav>
                <a href="{{ click_tracker_url }}"><i class="fas fa-mouse-pointer"></i> Tracker</a>
                <a href="/"><i class="fas fa-chart-line"></i> Dashboard</a>
            </nav>
        </header>

        <div id="msg"></div>

        {% if user %}
        <!-- Logged In -->
        <div class="sso-banner">
            <i class="fas fa-link"></i>
            <div class="text">
                <strong>Single Sign-On Active</strong><br>
                You're logged in across all apps! <a href="{{ click_tracker_url }}">Visit Click Tracker →</a>
            </div>
        </div>

        <div class="card">
            <div class="user-bar">
                <div class="avatar {{ role }}">
                    {% if role == 'admin' %}<i class="fas fa-crown"></i>
                    {% elif role == 'tracker' %}<i class="fas fa-chart-line"></i>
                    {% else %}<i class="fas fa-mouse-pointer"></i>{% endif %}
                </div>
                <div class="info">
                    <strong>{{ user.email }}</strong>
                    <span class="badge {{ role }}">{{ role }}</span>
                    <span class="badge sso">SSO</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()">Logout (All Apps)</button>
            </div>
        </div>

        {% if can_view_analytics %}
        <!-- Has Access -->
        <div class="cross-banner">
            <i class="fas fa-database"></i>
            <div class="text">
                <strong>Cross-App Data Access</strong><br>
                This dashboard reads data from <code>click_tracker</code> via <code>read_scopes</code> in manifest.json
            </div>
            <span class="badge cross">CROSS-APP</span>
        </div>

        <div class="card">
            <h2>Click Analytics (24h) <span class="badge cross" style="font-size:0.65rem">from click_tracker</span></h2>
            <div class="stats" id="stats">
                <div class="stat"><div class="num">-</div><div class="label">Total</div></div>
                <div class="stat"><div class="num">-</div><div class="label">Users</div></div>
                <div class="stat"><div class="num">-</div><div class="label">Top Hits</div></div>
                <div class="stat"><div class="num">24h</div><div class="label">Period</div></div>
            </div>
        </div>

        <div class="card">
            <h2>Clicks by Role</h2>
            <div class="role-bars" id="roles">
                <div class="role-bar"><div class="num">-</div><span class="badge admin">admin</span></div>
                <div class="role-bar"><div class="num">-</div><span class="badge tracker">tracker</span></div>
                <div class="role-bar"><div class="num">-</div><span class="badge clicker">clicker</span></div>
            </div>
        </div>

        <div class="card">
            <h2>Recent Activity</h2>
            <div id="recent"><p style="color:var(--muted)">Loading...</p></div>
        </div>

        {% if can_manage_users %}
        <div class="card">
            <h2>User Management <span class="badge sso" style="font-size:0.65rem">SharedUserPool</span></h2>
            <p style="color:var(--muted);margin-bottom:1rem;font-size:0.85rem">Manage roles for ALL apps from here! Changes apply immediately via SSO.</p>
            <div id="users"><p style="color:var(--muted)">Loading...</p></div>
            <div class="admin-panel">
                <h3><i class="fas fa-user-edit"></i> Update User Role</h3>
                <form class="admin-form" onsubmit="updateRole(event)">
                    <input type="email" id="email" placeholder="user@example.com" required>
                    <select id="targetApp">
                        <option value="dashboard">Dashboard</option>
                        <option value="click_tracker">Click Tracker</option>
                    </select>
                    <select id="newRole">
                        <option value="clicker">Clicker</option>
                        <option value="tracker">Tracker</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button type="submit" class="btn btn-primary">Update</button>
                </form>
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- No Access (Clicker) -->
        <div class="card">
            <div class="denied">
                <i class="fas fa-lock"></i>
                <h3>Access Restricted</h3>
                <p>Your <strong>dashboard</strong> role is <span class="badge clicker">clicker</span> - no analytics access.<br>You need tracker or admin role on this app.</p>
                <a href="{{ click_tracker_url }}" class="btn btn-primary">Go to Click Tracker</a>
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- Not Logged In -->
        <div class="sso-banner">
            <i class="fas fa-key"></i>
            <div class="text">
                <strong>Single Sign-On Demo</strong><br>
                Login here OR on <a href="{{ click_tracker_url }}">Click Tracker</a> - you'll be authenticated on BOTH apps!
            </div>
        </div>

        <div class="card">
            <h2>Role Permissions</h2>
            <table>
                <tr><th>Permission</th><th><span class="badge clicker">Clicker</span></th><th><span class="badge tracker">Tracker</span></th><th><span class="badge admin">Admin</span></th></tr>
                <tr><td>Track clicks</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td></tr>
                <tr><td>View own clicks</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td></tr>
                <tr><td>View all clicks</td><td style="color:var(--error)">✗</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td></tr>
                <tr><td><strong>Dashboard access</strong></td><td style="color:var(--error)">✗</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td></tr>
                <tr><td>View analytics</td><td style="color:var(--error)">✗</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td></tr>
                <tr><td>Manage users</td><td style="color:var(--error)">✗</td><td style="color:var(--error)">✗</td><td style="color:var(--success)">✓</td></tr>
            </table>
            <p style="color:var(--muted);margin-top:1rem;font-size:0.85rem"><i class="fas fa-info-circle"></i> Roles are per-app via <code>app_roles</code> in SharedUserPool</p>
        </div>

        <div class="card">
            <h2>Quick Login - Demo Users</h2>
            <p style="color:var(--muted);margin-bottom:1rem">Only tracker and admin can view analytics</p>
            <div class="demo-grid">
                <div class="demo-card admin" onclick="login('alice@example.com')">
                    <div class="avatar admin"><i class="fas fa-crown"></i></div>
                    <h3>Alice</h3>
                    <span class="badge admin">Admin</span>
                    <p>Full access + user mgmt</p>
                    <div class="access yes">✓ Dashboard Access</div>
                </div>
                <div class="demo-card tracker" onclick="login('bob@example.com')">
                    <div class="avatar tracker"><i class="fas fa-chart-line"></i></div>
                    <h3>Bob</h3>
                    <span class="badge tracker">Tracker</span>
                    <p>View analytics</p>
                    <div class="access yes">✓ Dashboard Access</div>
                </div>
                <div class="demo-card clicker" onclick="login('charlie@example.com')">
                    <div class="avatar clicker"><i class="fas fa-mouse-pointer"></i></div>
                    <h3>Charlie</h3>
                    <span class="badge clicker">Clicker</span>
                    <p>Track only</p>
                    <div class="access no">✗ No Access</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>How It Works</h2>
            <table>
                <tr><td><i class="fas fa-link" style="color:var(--sso)"></i></td><td><strong>SSO</strong></td><td>SharedUserPool + shared JWT cookie <code>mdb_auth_token</code></td></tr>
                <tr><td><i class="fas fa-database" style="color:var(--cross)"></i></td><td><strong>Cross-App Data</strong></td><td>Dashboard reads <code>click_tracker_clicks</code> via <code>read_scopes</code></td></tr>
                <tr><td><i class="fas fa-user-tag" style="color:var(--accent)"></i></td><td><strong>Per-App Roles</strong></td><td><code>app_roles: {dashboard: ["admin"], click_tracker: ["admin"]}</code></td></tr>
            </table>
        </div>
        {% endif %}
    </div>

    <script>
        // Configuration from server
        const clickTrackerUrl = '{{ click_tracker_url }}';
        
        // Helper to read cookies for CSRF token
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }

        async function login(email) {
            show('Logging in (SSO)...', 'info');
            const form = new FormData();
            form.append('email', email);
            form.append('password', 'password123');
            const res = await fetch('/login', { 
                method: 'POST', 
                body: form,
                headers: { 'X-CSRF-Token': getCookie('csrf_token') }
            });
            const data = await res.json();
            if (data.success) {
                show('Logged in! You are now authenticated on all apps.', 'success');
                setTimeout(() => location.reload(), 1000);
            }
            else show(data.detail || 'Login failed', 'error');
        }

        async function logout() {
            show('Logging out from all apps...', 'info');
            await fetch('/logout', { 
                method: 'POST',
                headers: { 'X-CSRF-Token': getCookie('csrf_token') }
            });
            setTimeout(() => location.reload(), 500);
        }

        async function loadAnalytics() {
            const res = await fetch('/analytics');
            if (!res.ok) return;
            const data = await res.json();
            
            // Stats
            const stats = document.querySelectorAll('.stat .num');
            stats[0].textContent = data.total_clicks;
            stats[1].textContent = data.unique_users;
            stats[2].textContent = data.top_urls[0]?.count || 0;
            
            // Role breakdown
            const roles = data.clicks_by_role;
            document.getElementById('roles').innerHTML = `
                <div class="role-bar"><div class="num">${roles.admin || 0}</div><span class="badge admin">admin</span></div>
                <div class="role-bar"><div class="num">${roles.tracker || 0}</div><span class="badge tracker">tracker</span></div>
                <div class="role-bar"><div class="num">${roles.clicker || 0}</div><span class="badge clicker">clicker</span></div>
            `;
            
            // Recent
            if (data.recent_clicks.length === 0) {
                document.getElementById('recent').innerHTML = `<p style="color:var(--muted)">No clicks yet. Go to <a href="${clickTrackerUrl}">Click Tracker</a> and track some clicks!</p>`;
                return;
            }
            let html = '<table><tr><th>User</th><th>Role</th><th>URL</th><th>Time</th></tr>';
            for (const c of data.recent_clicks) {
                html += `<tr><td>${c.user_id}</td><td><span class="badge ${c.user_role}">${c.user_role}</span></td><td>${c.url}</td><td>${new Date(c.timestamp).toLocaleString()}</td></tr>`;
            }
            document.getElementById('recent').innerHTML = html + '</table>';
        }

        async function loadUsers() {
            const res = await fetch('/admin/users');
            if (!res.ok) return;
            const data = await res.json();
            
            let html = '<table><tr><th>Email</th><th>Click Tracker</th><th>Dashboard</th><th>Created</th></tr>';
            for (const u of data.users) {
                const ctRole = u.click_tracker_role?.[0] || 'none';
                const dbRole = u.dashboard_role?.[0] || 'none';
                html += `<tr>
                    <td>${u.email}</td>
                    <td><span class="badge ${ctRole}">${ctRole}</span></td>
                    <td><span class="badge ${dbRole}">${dbRole}</span></td>
                    <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
                </tr>`;
            }
            document.getElementById('users').innerHTML = html + '</table>';
        }

        async function updateRole(e) {
            e.preventDefault();
            const form = new FormData();
            form.append('email', document.getElementById('email').value);
            form.append('role', document.getElementById('newRole').value);
            form.append('target_app', document.getElementById('targetApp').value);
            const res = await fetch('/admin/update-role', { 
                method: 'POST', 
                body: form,
                headers: { 'X-CSRF-Token': getCookie('csrf_token') }
            });
            const data = await res.json();
            if (data.success) { 
                show(data.message, 'success'); 
                loadUsers(); 
            }
            else show(data.detail || 'Failed', 'error');
        }

        function show(text, type) {
            document.getElementById('msg').innerHTML = `<div class="msg ${type}">${text}</div>`;
            if (type !== 'info') setTimeout(() => document.getElementById('msg').innerHTML = '', 3000);
        }

        {% if user and can_view_analytics %}
        loadAnalytics();
        {% if can_manage_users %}loadUsers();{% endif %}
        {% endif %}
    </script>
</body>
</html>
