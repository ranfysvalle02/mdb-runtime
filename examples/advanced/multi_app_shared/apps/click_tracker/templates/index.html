<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Click Tracker (SSO)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f0f12;
            --card: #1a1a1f;
            --accent: #06b6d4;
            --tracker: #8b5cf6;
            --admin: #f59e0b;
            --text: #f4f4f5;
            --muted: #71717a;
            --success: #22c55e;
            --error: #ef4444;
            --sso: #10b981;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 2rem; }
        .container { max-width: 800px; margin: 0 auto; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
        h1 i { color: var(--accent); }
        
        .card { background: var(--card); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; }
        .card h2 { font-size: 1rem; color: var(--muted); margin-bottom: 1rem; }
        
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge.clicker { background: rgba(6, 182, 212, 0.2); color: var(--accent); }
        .badge.tracker { background: rgba(139, 92, 246, 0.2); color: var(--tracker); }
        .badge.admin { background: rgba(245, 158, 11, 0.2); color: var(--admin); }
        .badge.sso { background: rgba(16, 185, 129, 0.2); color: var(--sso); }
        
        .sso-banner { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.1)); border: 1px solid var(--sso); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; }
        .sso-banner i { color: var(--sso); font-size: 1.5rem; }
        .sso-banner .text { flex: 1; }
        .sso-banner .text strong { color: var(--sso); }
        .sso-banner a { color: var(--sso); text-decoration: underline; }
        
        .demo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        @media (max-width: 600px) { .demo-grid { grid-template-columns: 1fr; } }
        
        .demo-card { background: var(--bg); border: 2px solid transparent; border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .demo-card:hover { transform: translateY(-2px); }
        .demo-card.clicker { border-color: var(--accent); }
        .demo-card.tracker { border-color: var(--tracker); }
        .demo-card.admin { border-color: var(--admin); }
        .demo-card h3 { margin: 0.5rem 0; }
        .demo-card p { font-size: 0.8rem; color: var(--muted); }
        
        .avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 1.25rem; }
        .avatar.clicker { background: rgba(6, 182, 212, 0.2); color: var(--accent); }
        .avatar.tracker { background: rgba(139, 92, 246, 0.2); color: var(--tracker); }
        .avatar.admin { background: rgba(245, 158, 11, 0.2); color: var(--admin); }
        
        .btn { padding: 0.75rem 1.5rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background: transparent; border: 1px solid var(--muted); color: var(--text); }
        
        .user-bar { display: flex; align-items: center; gap: 1rem; }
        .user-bar .info { flex: 1; }
        
        .counter { text-align: center; padding: 2rem; }
        .counter .num { font-size: 4rem; font-weight: 800; color: var(--accent); }
        .counter .label { color: var(--muted); }
        .track-btn { margin-top: 1rem; padding: 1rem 3rem; font-size: 1.1rem; background: linear-gradient(135deg, var(--accent), var(--tracker)); color: #fff; border: none; border-radius: 12px; cursor: pointer; }
        .track-btn:hover { transform: scale(1.02); }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--bg); }
        th { color: var(--muted); font-size: 0.75rem; text-transform: uppercase; }
        
        .msg { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .msg.success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .msg.error { background: rgba(239, 68, 68, 0.2); color: var(--error); }
        .msg.info { background: rgba(6, 182, 212, 0.1); color: var(--accent); }
        
        .note { background: var(--bg); padding: 1rem; border-radius: 8px; font-size: 0.9rem; color: var(--muted); display: flex; align-items: center; gap: 0.5rem; }
        .note i { color: var(--accent); }
        
        nav a { color: var(--muted); text-decoration: none; margin-left: 1rem; }
        nav a:hover { color: var(--text); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-mouse-pointer"></i> Click Tracker <span class="badge sso">SSO</span></h1>
            <nav>
                <a href="/"><i class="fas fa-mouse-pointer"></i> Tracker</a>
                <a href="{{ dashboard_url }}"><i class="fas fa-chart-line"></i> Dashboard</a>
            </nav>
        </header>

        <div id="msg"></div>

        {% if user %}
        <!-- Logged In -->
        <div class="sso-banner">
            <i class="fas fa-link"></i>
            <div class="text">
                <strong>Single Sign-On Active</strong><br>
                You're logged in across all apps! <a href="{{ dashboard_url }}">Visit Dashboard →</a>
            </div>
        </div>

        <div class="card">
            <div class="user-bar">
                <div class="avatar {{ role }}">
                    {% if role == 'admin' %}<i class="fas fa-crown"></i>
                    {% elif role == 'tracker' %}<i class="fas fa-chart-line"></i>
                    {% else %}<i class="fas fa-mouse-pointer"></i>{% endif %}
                </div>
                <div class="info">
                    <strong>{{ user.email }}</strong>
                    <span class="badge {{ role }}">{{ role }}</span>
                    <span class="badge sso">SSO</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()">Logout (All Apps)</button>
            </div>
        </div>

        <div class="card">
            <div class="counter">
                <div class="num" id="count">-</div>
                <div class="label">{% if can_view_all %}All Clicks{% else %}Your Clicks{% endif %}</div>
                <button class="track-btn" onclick="track()"><i class="fas fa-plus"></i> Track Click</button>
            </div>
        </div>

        {% if not can_view_all %}
        <div class="note"><i class="fas fa-info-circle"></i> As a clicker, you only see your own clicks. Upgrade to tracker to see all!</div>
        {% endif %}

        <div class="card">
            <h2>Recent Clicks</h2>
            <div id="clicks"><p style="color:var(--muted)">Loading...</p></div>
        </div>

        {% else %}
        <!-- Not Logged In -->
        <div class="sso-banner">
            <i class="fas fa-key"></i>
            <div class="text">
                <strong>Single Sign-On Demo</strong><br>
                Login here and you'll be automatically logged into <a href="{{ dashboard_url }}">Dashboard</a> too!
            </div>
        </div>

        <div class="card">
            <h2>Quick Login - Demo Users</h2>
            <p style="color:var(--muted);margin-bottom:1rem">Click a user to login (password: password123)</p>
            <div class="demo-grid">
                <div class="demo-card admin" onclick="login('alice@example.com')">
                    <div class="avatar admin"><i class="fas fa-crown"></i></div>
                    <h3>Alice</h3>
                    <span class="badge admin">Admin</span>
                    <p>Full access to both apps</p>
                </div>
                <div class="demo-card tracker" onclick="login('bob@example.com')">
                    <div class="avatar tracker"><i class="fas fa-chart-line"></i></div>
                    <h3>Bob</h3>
                    <span class="badge tracker">Tracker</span>
                    <p>View all clicks + analytics</p>
                </div>
                <div class="demo-card clicker" onclick="login('charlie@example.com')">
                    <div class="avatar clicker"><i class="fas fa-mouse-pointer"></i></div>
                    <h3>Charlie</h3>
                    <span class="badge clicker">Clicker</span>
                    <p>Own clicks only, no dashboard</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Role Permissions</h2>
            <table>
                <tr><th>Permission</th><th><span class="badge clicker">Clicker</span></th><th><span class="badge tracker">Tracker</span></th><th><span class="badge admin">Admin</span></th></tr>
                <tr><td>Track clicks</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td></tr>
                <tr><td>View own clicks</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td></tr>
                <tr><td>View all clicks</td><td style="color:var(--error)">✗</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td></tr>
                <tr><td>Dashboard access</td><td style="color:var(--error)">✗</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td></tr>
                <tr><td>View analytics</td><td style="color:var(--error)">✗</td><td style="color:var(--success)">✓</td><td style="color:var(--success)">✓</td></tr>
                <tr><td>Manage users</td><td style="color:var(--error)">✗</td><td style="color:var(--error)">✗</td><td style="color:var(--success)">✓</td></tr>
            </table>
            <p style="color:var(--muted);margin-top:1rem;font-size:0.85rem"><i class="fas fa-info-circle"></i> Roles are per-app via <code>app_roles</code> in SharedUserPool. Managed in <code>manifest.json</code></p>
        </div>

        <div class="card">
            <h2>How SSO Works</h2>
            <table>
                <tr><td><i class="fas fa-database" style="color:var(--sso)"></i></td><td><strong>SharedUserPool</strong></td><td>Centralized user storage in <code>_mdb_engine_shared_users</code></td></tr>
                <tr><td><i class="fas fa-key" style="color:var(--sso)"></i></td><td><strong>JWT Tokens</strong></td><td>Stateless auth via shared <code>MDB_ENGINE_JWT_SECRET</code></td></tr>
                <tr><td><i class="fas fa-cookie" style="color:var(--sso)"></i></td><td><strong>Shared Cookie</strong></td><td><code>mdb_auth_token</code> works across all apps</td></tr>
                <tr><td><i class="fas fa-user-tag" style="color:var(--sso)"></i></td><td><strong>Per-App Roles</strong></td><td><code>app_roles: {click_tracker: ["admin"], dashboard: ["admin"]}</code></td></tr>
            </table>
        </div>
        {% endif %}
    </div>

    <script>
        // Helper to read cookies for CSRF token
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }

        async function login(email) {
            show('Logging in (SSO)...', 'info');
            const form = new FormData();
            form.append('email', email);
            form.append('password', 'password123');
            const res = await fetch('/login', { 
                method: 'POST', 
                body: form,
                headers: { 'X-CSRF-Token': getCookie('csrf_token') }
            });
            const data = await res.json();
            if (data.success) {
                show('Logged in! You are now authenticated on all apps.', 'success');
                setTimeout(() => location.reload(), 1000);
            }
            else show(data.detail || 'Login failed', 'error');
        }

        async function logout() {
            show('Logging out from all apps...', 'info');
            await fetch('/logout', { 
                method: 'POST',
                headers: { 'X-CSRF-Token': getCookie('csrf_token') }
            });
            setTimeout(() => location.reload(), 500);
        }

        async function track() {
            const res = await fetch('/track', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': getCookie('csrf_token')
                },
                body: JSON.stringify({ url: '/', element: 'track-button' })
            });
            if (res.ok) { show('Click tracked!', 'success'); loadClicks(); }
            else show('Failed to track', 'error');
        }

        async function loadClicks() {
            const res = await fetch('/clicks');
            const data = await res.json();
            document.getElementById('count').textContent = data.count;
            
            if (data.clicks.length === 0) {
                document.getElementById('clicks').innerHTML = '<p style="color:var(--muted)">No clicks yet. Click the button above!</p>';
                return;
            }
            
            let html = '<table><tr><th>User</th><th>Role</th><th>URL</th><th>Time</th></tr>';
            for (const c of data.clicks) {
                html += `<tr><td>${c.user_id}</td><td><span class="badge ${c.user_role}">${c.user_role}</span></td><td>${c.url}</td><td>${new Date(c.timestamp).toLocaleString()}</td></tr>`;
            }
            html += '</table>';
            if (!data.viewing_all) html += '<p style="color:var(--muted);margin-top:1rem;font-size:0.85rem">Showing only your clicks</p>';
            document.getElementById('clicks').innerHTML = html;
        }

        function show(text, type) {
            document.getElementById('msg').innerHTML = `<div class="msg ${type}">${text}</div>`;
            if (type !== 'info') setTimeout(() => document.getElementById('msg').innerHTML = '', 3000);
        }

        {% if user %}loadClicks();{% endif %}
    </script>
</body>
</html>
