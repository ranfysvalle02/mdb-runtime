#!/bin/sh

# Pre-commit hook - Staff Engineer Level
# Optimized for performance: only checks changed files, uses caching, parallel execution

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Allow skipping hooks with environment variable
if [ "$SKIP_HOOKS" = "1" ]; then
    echo "${YELLOW}‚ö†Ô∏è  Skipping pre-commit checks (SKIP_HOOKS=1)${NC}"
    exit 0
fi

echo "${BLUE}üîç Running pre-commit checks...${NC}"

# Get the directory where the hook is located (project root)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT" || exit 1

# Get list of staged Python files (optimization: only check changed files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py)$' || echo "")

# If no Python files staged, skip checks
if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}‚úÖ No Python files staged, skipping checks${NC}"
    exit 0
fi

# Count files for progress
FILE_COUNT=$(echo "$STAGED_FILES" | grep -c . || echo "0")
echo "${BLUE}üìù Checking ${FILE_COUNT} staged file(s)...${NC}"

# Check if required tools are available
if ! command -v ruff >/dev/null 2>&1; then
    echo "${YELLOW}‚ö†Ô∏è  Warning: ruff not found. Installing dev dependencies...${NC}"
    if ! pip install -e ".[dev]" >/dev/null 2>&1; then
        echo "${RED}‚ùå Error: Failed to install dev dependencies.${NC}"
        echo "   Run: pip install -e '.[dev]'"
        exit 1
    fi
fi

# Auto-format only staged files (performance optimization)
echo "${BLUE}üìù Auto-formatting staged files...${NC}"
if [ -n "$STAGED_FILES" ]; then
    if ! echo "$STAGED_FILES" | xargs ruff format 2>&1; then
        echo "${RED}‚ùå Error: 'ruff format' failed${NC}"
        exit 1
    fi
fi

# Stage any formatting changes (so they're included in the commit)
FORMATTED_FILES=$(git diff --name-only)
if [ -n "$FORMATTED_FILES" ]; then
    echo "${BLUE}üìù Staging auto-formatted files...${NC}"
    echo "$FORMATTED_FILES" | xargs git add
    echo "${GREEN}‚úÖ Formatted files staged for commit${NC}"
fi

# Run linting on staged files only (performance optimization)
echo "${BLUE}üîç Running lint checks on staged files...${NC}"
if [ -n "$STAGED_FILES" ]; then
    if ! echo "$STAGED_FILES" | xargs ruff check 2>&1; then
        echo "${RED}‚ùå Error: Linting failed on staged files${NC}"
        echo "   Run 'make lint-local' to see all issues"
        exit 1
    fi
fi

echo "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
