#!/bin/sh

# Pre-push hook to ensure code is formatted and linted before pushing
# This hook runs `make format` and `make lint-local` before allowing a push
#
# To skip this hook (not recommended): SKIP_HOOKS=1 git push

# Allow skipping hooks with environment variable
if [ "$SKIP_HOOKS" = "1" ]; then
    echo "âš ï¸  Skipping pre-push checks (SKIP_HOOKS=1)"
    exit 0
fi

echo "ğŸ” Running pre-push checks..."

# Get the directory where the hook is located (project root)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT" || exit 1

# Check if required tools are available
if ! command -v ruff >/dev/null 2>&1; then
    echo "âš ï¸  Warning: ruff not found. Installing dev dependencies..."
    if ! pip install -e ".[dev]" >/dev/null 2>&1; then
        echo "âŒ Error: Failed to install dev dependencies. Please run: pip install -e '.[dev]'"
        exit 1
    fi
fi

# Run make format first (auto-fixes issues)
echo "ğŸ“ Formatting code with 'make format'..."
if ! make format >/dev/null 2>&1; then
    echo "âŒ Error: 'make format' failed. Please fix formatting issues and try again."
    echo "   Run 'make format' manually to see detailed errors."
    exit 1
fi

# Check if formatting changed any files
if [ -n "$(git diff --name-only)" ]; then
    echo "âš ï¸  Warning: 'make format' modified some files. Please review and commit the changes before pushing."
    echo "Modified files:"
    git diff --name-only | sed 's/^/   - /'
    echo ""
    echo "You can review changes with: git diff"
    echo "To commit the formatting changes: git add . && git commit -m 'Format code'"
    exit 1
fi

# Run lint-local for comprehensive checks (includes formatting + code quality + semgrep)
echo "ğŸ” Running lint checks (lint-local includes formatting + code quality + semgrep)..."
if ! make lint-local 2>&1; then
    echo "âŒ Error: 'make lint-local' failed. Please fix linting issues and try again."
    echo "   Run 'make lint-local' manually to see detailed errors."
    exit 1
fi

echo "âœ… All pre-push checks passed!"
exit 0

