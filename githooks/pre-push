#!/bin/sh

# Pre-push hook to verify code quality before pushing
# This hook verifies that code is properly formatted and linted
# Note: Formatting and linting should be handled by pre-commit hook
#
# To skip this hook (not recommended): SKIP_HOOKS=1 git push

# Allow skipping hooks with environment variable
if [ "$SKIP_HOOKS" = "1" ]; then
    echo "‚ö†Ô∏è  Skipping pre-push checks (SKIP_HOOKS=1)"
    exit 0
fi

echo "üîç Running pre-push verification..."

# Get the directory where the hook is located (project root)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT" || exit 1

# Check if required tools are available
if ! command -v ruff >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Warning: ruff not found. Installing dev dependencies..."
    if ! pip install -e ".[dev]" >/dev/null 2>&1; then
        echo "‚ùå Error: Failed to install dev dependencies. Please run: pip install -e '.[dev]'"
        exit 1
    fi
fi

# Verify formatting (read-only check, no auto-fix)
echo "üìù Verifying code formatting..."
if ! ruff format --check mdb_engine tests scripts >/dev/null 2>&1; then
    echo "‚ùå Error: Code formatting check failed!"
    echo "   Some files are not properly formatted."
    echo "   Run 'make format' and commit the changes."
    echo ""
    echo "   Files that need formatting:"
    ruff format --check mdb_engine tests scripts 2>&1 | grep "Would reformat" || true
    exit 1
fi

# Verify linting (read-only check)
echo "üîç Verifying code quality..."
if ! make lint-ci 2>&1; then
    echo "‚ùå Error: Code quality check failed!"
    echo "   Run 'make lint-local' to see issues and fix them."
    exit 1
fi

# Optional: Run integration tests (can be skipped with SKIP_INTEGRATION_TESTS=1)
if [ "$SKIP_INTEGRATION_TESTS" != "1" ] && command -v docker &> /dev/null; then
    echo "üê≥ Running integration tests (requires Docker)..."
    if make test-integration >/dev/null 2>&1; then
        echo "‚úÖ Integration tests passed!"
    else
        echo "‚ö†Ô∏è  Integration tests failed or Docker not available."
        echo "   To skip integration tests: SKIP_INTEGRATION_TESTS=1 git push"
        echo "   To see errors: make test-integration"
        # Don't block push - integration tests are optional
    fi
else
    if [ "$SKIP_INTEGRATION_TESTS" = "1" ]; then
        echo "‚è≠Ô∏è  Skipping integration tests (SKIP_INTEGRATION_TESTS=1)"
    elif ! command -v docker &> /dev/null; then
        echo "‚è≠Ô∏è  Skipping integration tests (Docker not available)"
        echo "   Install Docker to run integration tests before push"
    fi
fi

echo "‚úÖ All pre-push checks passed!"
exit 0

