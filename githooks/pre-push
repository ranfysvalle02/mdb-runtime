#!/bin/sh

# Pre-push hook to verify code quality before pushing
# This hook verifies that code is properly formatted and linted
# Note: Formatting and linting should be handled by pre-commit hook
#
# To skip this hook (not recommended): SKIP_HOOKS=1 git push

# Allow skipping hooks with environment variable
if [ "$SKIP_HOOKS" = "1" ]; then
    echo "âš ï¸  Skipping pre-push checks (SKIP_HOOKS=1)"
    exit 0
fi

echo "ğŸ” Running pre-push verification..."

# Get the directory where the hook is located (project root)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT" || exit 1

# Check if required tools are available
if ! command -v ruff >/dev/null 2>&1; then
    echo "âš ï¸  Warning: ruff not found. Installing dev dependencies..."
    if ! pip install -e ".[dev]" >/dev/null 2>&1; then
        echo "âŒ Error: Failed to install dev dependencies. Please run: pip install -e '.[dev]'"
        exit 1
    fi
fi

# Verify formatting (read-only check, no auto-fix)
echo "ğŸ“ Verifying code formatting..."
if ! ruff format --check mdb_engine tests scripts >/dev/null 2>&1; then
    echo "âŒ Error: Code formatting check failed!"
    echo "   Some files are not properly formatted."
    echo "   Run 'make format' and commit the changes."
    echo ""
    echo "   Files that need formatting:"
    ruff format --check mdb_engine tests scripts 2>&1 | grep "Would reformat" || true
    exit 1
fi

# Verify linting (read-only check)
echo "ğŸ” Verifying code quality..."
if ! make lint-ci 2>&1; then
    echo "âŒ Error: Code quality check failed!"
    echo "   Run 'make lint-local' to see issues and fix them."
    exit 1
fi

echo "âœ… All pre-push checks passed!"
echo ""
echo "ğŸ’¡ Note: Integration tests run in CI/CD, not locally."
exit 0

